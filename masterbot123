
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆ                                                                         â–ˆ
# â–ˆ                           MasterBot 12.92                               â–ˆ
# â–ˆ                                                                         â–ˆ
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Telegram-Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ñ… Ğ½Ğ° ĞºĞ²ĞµÑÑ‚Ñ‹.
# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»:
# - Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ´ĞµĞ»Ğ¾Ğº Ğ¸Ğ· AmoCRM Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼ Ğ¸ Ğ´Ğ°Ñ‚Ğ°Ğ¼.
# - ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¸ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ³Ñ€.
# - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Telegram-Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ñ….
# - Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼ Ğ¸ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ.
# - ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ AmoCRM Ğ¸ Google Sheets Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ.
# Ğ’ĞµÑ€ÑĞ¸Ñ: 12.92
# Ğ”Ğ°Ñ‚Ğ°: 13.05.2025

import asyncio
import json
import logging
import os
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any, Union
import pytz
from aiogram import Bot, Dispatcher, Router, types
from aiogram.exceptions import TelegramAPIError
from aiogram.filters import Command, CommandStart
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.client.bot import DefaultBotProperties
from apscheduler.schedulers.asyncio import AsyncIOScheduler
import gspread
from google.oauth2.service_account import Credentials
import aiohttp
from logging.handlers import RotatingFileHandler

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ¤Ğ¾Ñ€Ğ²Ğ°Ñ€Ğ´-Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Pylance Ğ²Ğ¸Ğ´ĞµĞ» get_distribution_keyboard
def get_distribution_keyboard() -> InlineKeyboardMarkup:
    """Ğ—Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ° Ğ´Ğ»Ñ IDE; Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ½Ğ¸Ğ¶Ğµ."""
    pass
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                       [1.0] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ                         â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ¾Ğ¹ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹.
# version: 1.2

LOG_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), "logs")
os.makedirs(LOG_DIR, exist_ok=True)

logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s [%(levelname)s] [%(name)s] [%(filename)s:%(lineno)d] %(message)s",
    handlers=[
        RotatingFileHandler(
            os.path.join(LOG_DIR, "masterbot.log"),
            maxBytes=10 * 1024 * 1024,  # 10 MB
            backupCount=5,
            encoding="utf-8"
        ),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# version: 1.2
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 1.0: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
# - 1.1 (11.05.2025): Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ° Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑÑ… Ğ»Ğ¾Ğ³Ğ¾Ğ².
# - 1.2 (13.05.2025): Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ğ°Ğ¿ĞºĞ° logs, ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ° ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ².

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                       [2.0] ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸ ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹                      â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ±Ğ¾Ñ‚Ğ°, Ğ¿ÑƒÑ‚Ğ¸ Ğº Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼, Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸.
# version: 1.13

# ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ±Ğ¾Ñ‚Ğ°
VERSION = "MasterBot 12.92"
CURRENT_YEAR = datetime.now().year
SPREADSHEET_NAME = f"Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ {CURRENT_YEAR}"
GOOGLE_API_RATE_LIMIT_SECONDS = 180
DATE_FILTER_THRESHOLD = timedelta(days=30)
POLL_DURATION = timedelta(hours=24)
CACHE_LIFETIME = timedelta(minutes=5)

# Ğ¢Ğ¾ĞºĞµĞ½Ñ‹ Ğ¸ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ñ‹
API_TOKEN = "7637424219:AAHXYNXHrRNZ1XwNbLx7ieBTZtafe6pmkYo"
LEADER_ID = os.getenv("MASTERBOT_LEADER_ID", "1018880781")

if not API_TOKEN or not isinstance(API_TOKEN, str):
    logger.critical("[2.0] API_TOKEN Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½ Ğ¸Ğ»Ğ¸ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ¹")
    raise SystemExit(1)
logger.info("[2.0] API_TOKEN ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½")

try:
    LEADER_ID = int(LEADER_ID)
except (ValueError, TypeError):
    logger.error("[2.0] MASTERBOT_LEADER_ID Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼, Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾: %s", LEADER_ID)
    raise SystemExit(1)

# ĞŸÑƒÑ‚Ğ¸ Ğº Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
LOG_FILE = os.path.join(BASE_DIR, "logs", "masterbot.log")
CHAT_ID_FILE = os.path.join(BASE_DIR, "chat_id.json")
MASTERBOT_DB = os.path.join(BASE_DIR, "masterbot.db")
CONFIG_FILE = os.path.join(BASE_DIR, "config.json")
TOKENS_FILE = os.path.join(BASE_DIR, "tokens.json")

# Ğ£Ñ‡ĞµÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Google Sheets
GOOGLE_CREDENTIALS_FILE = os.getenv("GOOGLE_CREDENTIALS_PATH")
if not GOOGLE_CREDENTIALS_FILE:
    possible_files = [
        "svetofor-credentials.json",
        "service-account-key.json",
        "credentials.json"
    ]
    for fname in possible_files:
        candidate = os.path.join(BASE_DIR, fname)
        if os.path.exists(candidate):
            GOOGLE_CREDENTIALS_FILE = candidate
            logger.info("[2.0] ĞĞ°Ğ¹Ğ´ĞµĞ½ Ñ„Ğ°Ğ¹Ğ» ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Google Sheets: %s", GOOGLE_CREDENTIALS_FILE)
            break

if GOOGLE_CREDENTIALS_FILE and os.path.exists(GOOGLE_CREDENTIALS_FILE):
    try:
        with open(GOOGLE_CREDENTIALS_FILE, 'r', encoding='utf-8') as f:
            creds_data = json.load(f)
            client_email = creds_data.get("client_email", "Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½")
            logger.info("[2.0] Ğ£Ñ‡ĞµÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Google Sheets Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹: client_email=%s", client_email)
    except (json.JSONDecodeError, KeyError) as e:
        logger.error("[2.0] ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Google Sheets: %s", e, exc_info=True)
        GOOGLE_CREDENTIALS_FILE = None
else:
    GOOGLE_CREDENTIALS_FILE = os.path.join(BASE_DIR, "svetofor-credentials.json")
    logger.warning(
        "[2.0] Ğ¤Ğ°Ğ¹Ğ» ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Google Sheets Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: %s. Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Google Sheets Ğ±ÑƒĞ´ÑƒÑ‚ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹.",
        GOOGLE_CREDENTIALS_FILE
    )

# ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹
SVETOFOR_SHEET = "Ğ¡Ğ²ĞµÑ‚Ğ¾Ñ„Ğ¾Ñ€"
DISTRIBUTION_SPREADSHEET_NAME = "Ğ¡Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ"
ALLOWED_STATUSES = ["Ğ‘Ñ€Ğ¾Ğ½ÑŒ", "Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ÑĞ´ĞµĞ»ĞºĞ¸", "ĞŸÑ€ĞµĞ´Ğ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°ÑĞ²ĞºĞ°"]
ALLOWED_STATUS_IDS = ["18913933", "18960415", "18913930"]
NEW_GAMES_STATUS_IDS = ["18913930", "18913933"]
SUCCESSFUL_STATUS_ID = "18960415"
DATE_FILTER_DAYS = 30
PREPAYMENT_FIELD_ID = None
PACKAGE_FIELD_ID = "71673"
MSK_TZ = pytz.timezone("Europe/Moscow")
GOOGLE_SHEETS_SCOPES = [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive"
]

# ĞŸÑ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
ACCESS = {
    "games": ["Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ", "Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€", "Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ğ¹", "Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ğ¹ Ğ½Ğ¾Ğ²Ğ¸Ñ‡Ğ¾Ğº"],
    "poll": ["Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ", "Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€"],
    "distribution": ["Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ", "Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€"],
}

# ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ½ĞµĞ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸
WEEKDAYS = {
    "Monday": "ĞŸĞ½", "Tuesday": "Ğ’Ñ‚", "Wednesday": "Ğ¡Ñ€", "Thursday": "Ğ§Ñ‚",
    "Friday": "ĞŸÑ‚", "Saturday": "Ğ¡Ğ±", "Sunday": "Ğ’ÑĞº",
}

# Ğ Ğ¾Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ¸Ğ³Ñ€
GAME_ROLE_MAPPING = {
    "ĞŸĞµÑ‚Ğ»Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸": {"main_leaders": 1, "assistants": 1},
    "Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸ Ğ²Ğ¾Ğ»ÑˆĞµĞ±ÑÑ‚Ğ²Ğ°": {"main_leaders": 1, "assistants": 1},
    "Ğ’Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¸ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹": {"main_leaders": 1, "assistants": 2},
    "ĞšĞ»Ğ°Ğ½Ñ‹ ĞÑŒÑ-Ğ™Ğ¾Ñ€ĞºĞ°": {"main_leaders": 1, "assistants": 3},
    "ĞšĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¾Ğ½ĞµÑ€ Ğ¸Ğ³Ñ€": {"main_leaders": 1, "assistants": 1},
    "Ğ‘ĞµÑ€Ğ¼ÑƒĞ´ÑĞºĞ¸Ğ¹ Ñ‚Ñ€ĞµÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸Ğº": {"main_leaders": 1, "assistants": 3},
    "Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ´Ğ¾Ğ¼": {"main_leaders": 1, "assistants": 1},
    "Ğ¦Ğ²ĞµÑ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ±Ğ°ÑˆĞ½Ñ": {"main_leaders": 2, "assistants": 0}
}


AMOCRM_FIELDS = {
    "event_date":     "87751",    # Ğ”Ğ°Ñ‚Ğ°
    "event_time":     "88565",    # Ğ²Ñ€ĞµĞ¼Ñ
    "game_name":      "87791",    # ĞšĞ²ĞµÑÑ‚
    "age":            "899511",   # Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²
    "extra_services": "452955",   # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ (ĞŸĞ¸Ğ½ÑŒÑÑ‚Ğ° Ğ² Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº)
    "comment":        "87811",    # ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹
    "prepayment":     "100407",   # ĞŸÑ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°
    "team_leads":     "88567",    # Ğ’ĞµĞ´ÑƒÑ‰Ğ¸Ğµ
    "photographer":   "87813",    # Ğ¤Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„
    "players":        "71635",    # ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²
    "package":        "71673",    # ĞŸĞ°ĞºĞµÑ‚ ÑƒÑĞ»ÑƒĞ³
}

# version: 1.13
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 1.0: Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ.
# - 1.2: Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ñ‚Ğ¾ĞºĞµĞ½Ğ°.
# - 1.3: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ğ° Ğ´Ğ»Ñ ÑĞ²Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹.
# - 1.4: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ñ‚Ğ¾ĞºĞµĞ½ Telegram-Ğ±Ğ¾Ñ‚Ğ°, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°.
# - 1.5: ĞŸĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ÑƒÑÑ‚Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ NameError.
# - 1.6: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….
# - 1.7: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° GOOGLE_CREDENTIALS_PATH.
# - 1.8: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¿Ğ¾Ğ¸ÑĞº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğ¼ Ğ¸Ğ¼ĞµĞ½Ğ°Ğ¼.
# - 1.9: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ client_email Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸.
# - 1.10: Ğ˜Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½ Ğ¿Ğ¾Ğ¸ÑĞº Ñ„Ğ°Ğ¹Ğ»Ğ° ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¸Ğ¼Ñ svetofor-credentials.json.
# - 1.11: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ñ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ğ°Ğ¼Ğ¸ Ğ² Ñ†Ğ¸ĞºĞ»Ğµ for.
# - 1.12 (12.05.2025): API_TOKEN Ğ¿Ñ€Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½ Ğ² ĞºĞ¾Ğ´Ğµ, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ MSK_TZ, GAME_ROLE_MAPPING, AMOCRM_FIELDS, ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ.
# - 1.13 (13.05.2025): ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¿ÑƒÑ‚Ğ¸ Ğº Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼ Ğ»Ğ¾Ğ³Ğ¾Ğ², Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ğ°Ğ¿ĞºĞ° logs.

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                       [3.0] Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ñ‹                            â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ° bot_data Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ.
# version: 1.2  (17.05.2025)  â† Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ games_by_user

class BotData:
    """ĞšĞ»Ğ°ÑÑ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°."""
    def __init__(self):
        self.config: Dict = {}
        self.tokens: Dict = {}
        self.admin_chat_id: Optional[int] = None
        self.svetofor_spreadsheet_id: Optional[str] = None
        self.responses: Dict = {}
        self.current_poll_deals: List[Dict] = []
        self.distribution_cache: Dict = {}
        self.personal_report_message_id: Optional[int] = None
        self.current_poll_leader: Optional[int] = None
        self.coordination_cycle_active: bool = False
        self.distribution_keyboard: Optional[InlineKeyboardMarkup] = None
        self.current_event_period: Optional[List[datetime]] = None
        self.last_event_period: Optional[List[datetime]] = None
        self.pipeline_mapping: Dict = {}
        self.deals_cache: Dict = {}
        self.messages_to_delete: Dict[int, List[int]] = {}
        # ğŸ†•Â Ğ·Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞºĞ¸ Ğ¸Ğ³Ñ€, Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        self.games_by_user: Dict[int, List[Dict]] = {}

bot_data = BotData()

# versionâ€‘history:
# - 1.0: Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°
# - 1.1 (11.05.2025): Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ deals_cache, messages_to_delete
# - 1.2 (17.05.2025): games_by_user Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                           [4.0] Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹                                   â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸.
# version: 1.1

def parse_players_count(players: Any) -> int:
    """Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ¸Ğ· ÑÑ‚Ñ€Ğ¾ĞºĞ¸.

    Args:
        players: Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ñ players (ÑÑ‚Ñ€Ğ¾ĞºĞ°, Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¸Ğ»Ğ¸ None).

    Returns:
        int: ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ¸Ğ»Ğ¸ 0 Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ.
    """
    try:
        if not players:
            return 0
        players_str = str(players).strip()
        if "-" in players_str:
            return int(players_str.split("-")[-1].strip())
        return int(players_str)
    except (ValueError, TypeError) as e:
        logger.warning("[4.0] parse_players_count: ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ players=%s: %s", players, e)
        return 0

async def load_json(file_path: str) -> Dict:
    """Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ JSON-Ñ„Ğ°Ğ¹Ğ».

    Args:
        file_path: ĞŸÑƒÑ‚ÑŒ Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ.

    Returns:
        Dict: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°.

    Raises:
        FileNotFoundError: Ğ•ÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.
        json.JSONDecodeError: Ğ•ÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ JSON.
    """
    if not os.path.exists(file_path):
        logger.error("[4.0] load_json: Ğ¤Ğ°Ğ¹Ğ» %s Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", file_path)
        raise FileNotFoundError(f"Ğ¤Ğ°Ğ¹Ğ» {file_path} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            data = json.load(f)
            logger.debug("[4.0] load_json: Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ñ„Ğ°Ğ¹Ğ» %s", file_path)
            return data
    except json.JSONDecodeError as e:
        logger.error("[4.0] load_json: ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ JSON Ğ² %s: %s", file_path, e)
        raise

async def save_json(file_path: str, data: Dict) -> bool:
    """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² JSON-Ñ„Ğ°Ğ¹Ğ».

    Args:
        file_path: ĞŸÑƒÑ‚ÑŒ Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ.
        data: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ.

    Returns:
        bool: Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸.
    """
    try:
        with open(file_path, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2, ensure_ascii=False)
        logger.debug("[4.0] save_json: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ² %s", file_path)
        return True
    except Exception as e:
        logger.error("[4.0] save_json: ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ %s: %s", file_path, e, exc_info=True)
        return False

# version: 1.1
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 1.0: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹.
# - 1.1 (11.05.2025): Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸ĞµĞ¼ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°.

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                   [5.0] Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Google Sheets                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ§Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ»Ğ¸ÑÑ‚ Â«Ğ¡Ğ²ĞµÑ‚Ğ¾Ñ„Ğ¾Ñ€Â» Ğ¸Ğ· Google Sheets, ĞºĞµÑˆĞ¸Ñ€ÑƒÑ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸
#          Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ, Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾ Ñ†Ğ²ĞµÑ‚Ñƒ ÑÑ‡ĞµĞ¹ĞºĞ¸.
# version: 1.8 â€” ĞµĞ´Ğ¸Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° includeGridData, case-insensitive Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸

from typing import Optional
import gspread
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build

# Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ-ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ñ‹Ğ¹ ĞºĞµÑˆ
_svetofor_cache: dict = {
    "sheet": None,           # gspread.Worksheet
    "service": None,         # Google Sheets API client
    "spreadsheet_id": None,
    "rows": None,            # list[rowData]
    "headers": None,         # list[str] Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸
}

def _init_svetofor() -> None:
    """Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ sheet, service Ğ¸ spreadsheet_id Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·."""
    if _svetofor_cache["sheet"] is None:
        sid = bot_data.config.get("svetofor_spread_id")
        if not sid:
            raise RuntimeError("[5.0] _init_svetofor: 'svetofor_spread_id' Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½")
        creds = Credentials.from_service_account_file(
            GOOGLE_CREDENTIALS_FILE, scopes=GOOGLE_SHEETS_SCOPES
        )
        client = gspread.authorize(creds)
        sheet = client.open_by_key(sid).sheet1
        service = build("sheets", "v4", credentials=creds)

        _svetofor_cache.update({
            "sheet": sheet,
            "service": service,
            "spreadsheet_id": sid,
        })

def _load_svetofor_data() -> None:
    """
    Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ meta Ñ includeGridData Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ + Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸.
    Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ ĞµĞ´Ğ¸Ğ½Ğ¾Ğ¶Ğ´Ñ‹ Ğ·Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°.
    """
    if _svetofor_cache["rows"] is None:
        svc = _svetofor_cache["service"]
        sid = _svetofor_cache["spreadsheet_id"]
        meta = svc.spreadsheets().get(
            spreadsheetId=sid, includeGridData=True
        ).execute()

        # Ğ½Ğ°Ğ¹Ğ´Ñ‘Ğ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ sheetId
        props = _svetofor_cache["sheet"].id
        sheet_meta = next(
            s for s in meta["sheets"]
            if s["properties"]["sheetId"] == props
        )
        rows = sheet_meta["data"][0].get("rowData", [])
        # Ğ¿ĞµÑ€Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° â€” Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸
        header_cells = rows[0].get("values", [])
        headers = [
            c.get("formattedValue", "").strip()
            for c in header_cells
        ]

        _svetofor_cache["rows"] = rows
        _svetofor_cache["headers"] = headers

async def get_user_row_from_svetofor(user_id: int) -> Optional[int]:
    """
    Ğ˜Ñ‰ĞµÑ‚ user_id (Ğ² ĞºĞ¾Ğ»Ğ¾ÌĞ½ĞºĞµ B) Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ (1-based),
    Ğ¸Ğ»Ğ¸ None, ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.
    """
    try:
        _init_svetofor()
        _load_svetofor_data()
        rows = _svetofor_cache["rows"]
        target = str(user_id)
        for idx, row in enumerate(rows, start=1):
            vals = row.get("values", [])
            # ÑÑ‚Ğ¾Ğ»Ğ±ĞµÑ† B â†’ Ğ¸Ğ½Ğ´ĞµĞºÑ 1
            if len(vals) > 1 and vals[1].get("formattedValue", "").strip() == target:
                return idx
    except Exception as e:
        logger.error("[5.0] get_user_row_from_svetofor: %s", e, exc_info=True)
    return None

async def get_game_column_from_svetofor(game_name: str) -> Optional[int]:
    """
    Ğ˜Ñ‰ĞµÑ‚ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº game_name Ğ² Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞµ (Ğ±ĞµĞ· ÑƒÑ‡Ñ‘Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°),
    Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ ÑÑ‚Ğ¾Ğ»Ğ±Ñ†Ğ° (1-based) Ğ¸Ğ»Ğ¸ None.
    """
    try:
        _init_svetofor()
        _load_svetofor_data()
        norm = game_name.strip().lower()
        for idx, title in enumerate(_svetofor_cache["headers"], start=1):
            if title.lower() == norm:
                return idx
        logger.warning("[5.0] get_game_column: Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº %r Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", game_name)
    except Exception as e:
        logger.error("[5.0] get_game_column_from_svetofor: %s", e, exc_info=True)
    return None

def _rgb_to_status(r: float, g: float, b: float) -> str:
    """
    ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ backgroundColor Ğ¸Ğ· 0.0â€“1.0 Ğ²:
      green  if (g>0.5 and r<0.5)
      yellow if (r>0.5 and g>0.5)
      red    if (r>0.5 and g<0.5)
      ""     Ğ¸Ğ½Ğ°Ñ‡Ğµ
    """
    if g > 0.5 and r < 0.5:
        return "green"
    if r > 0.5 and g > 0.5:
        return "yellow"
    if r > 0.5 and g < 0.5:
        return "red"
    return ""

async def get_user_status_from_svetofor(user_id: int, game_name: str) -> str:
    """
    ĞŸĞ¾ user_id Ğ¸ game_name Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ†Ğ²ĞµÑ‚ ÑÑ‡ĞµĞ¹ĞºĞ¸:
    'green' | 'yellow' | 'red' | ''.
    """
    try:
        row = await get_user_row_from_svetofor(user_id)
        col = await get_game_column_from_svetofor(game_name)
        if not row or not col:
            return ""
        # Ğ±ĞµÑ€Ñ‘Ğ¼ Ğ¸Ğ· ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… rows
        cell = _svetofor_cache["rows"][row - 1] \
                    .get("values", [])[col - 1]
        bg = cell.get("effectiveFormat", {}) \
                 .get("backgroundColor", {})
        return _rgb_to_status(
            bg.get("red",   0.0),
            bg.get("green", 0.0),
            bg.get("blue",  0.0)
        )
    except Exception as e:
        logger.error("[5.0] get_user_status_from_svetofor: %s", e, exc_info=True)
        return ""


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                       [6.0] Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ AmoCRM                               â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² AmoCRM Ñ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼.
# version: 2.3

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ensure_valid_token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def ensure_valid_token() -> bool:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ True, ĞµÑĞ»Ğ¸ accessâ€‘token Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½ (Ğ¸Ğ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½)."""
    try:
        if not bot_data.tokens:
            bot_data.tokens = await load_json(TOKENS_FILE)
            if not bot_data.tokens:
                logger.error("[6.0] ensure_valid_token: Ñ„Ğ°Ğ¹Ğ» Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ¿ÑƒÑÑ‚ %s", TOKENS_FILE)
                return False

        expires_at = bot_data.tokens.get("expires_at", 0)
        if datetime.now().timestamp() >= expires_at - 300:
            logger.info("[6.0] ensure_valid_token: token Ğ¸ÑÑ‚ĞµĞºĞ°ĞµÑ‚, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ â€¦")
            return await refresh_amocrm_token()

        logger.debug("[6.0] ensure_valid_token: token ok Ğ´Ğ¾ %s",
                     datetime.fromtimestamp(expires_at))
        return True
    except Exception as e:
        logger.exception("[6.0] ensure_valid_token: ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° %s", e)
        return False


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ refresh_amocrm_token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def refresh_amocrm_token() -> bool:
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ refreshâ€‘Ñ‚Ğ¾ĞºĞµĞ½ Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ½Ğ° Ğ´Ğ¸ÑĞº."""
    try:
        cfg = bot_data.config or {}
        required = ("client_id", "client_secret", "redirect_uri", "domain")
        if any(k not in cfg for k in required):
            logger.error("[6.0] refresh_amocrm_token: Ğ½ĞµĞ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ AmoCRM %s", cfg)
            return False

        async with aiohttp.ClientSession() as s:
            payload = {
                "client_id":     cfg["client_id"],
                "client_secret": cfg["client_secret"],
                "grant_type":    "refresh_token",
                "refresh_token": bot_data.tokens.get("refresh_token", ""),
                "redirect_uri":  cfg["redirect_uri"],
            }
            async with s.post(f"https://{cfg['domain']}/oauth2/access_token",
                              json=payload) as r:
                if r.status != 200:
                    logger.error("[6.0] refresh_amocrm_token: HTTP %d â€“ %s",
                                 r.status, await r.text())
                    return False
                data = await r.json()
                data["expires_at"] = (
                    datetime.now() + timedelta(seconds=data.get("expires_in", 86400))
                ).timestamp()
                bot_data.tokens.update(data)
                await save_json(TOKENS_FILE, bot_data.tokens)
                logger.info("[6.0] refresh_amocrm_token: token Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½")
                return True
    except Exception as e:
        logger.exception("[6.0] refresh_amocrm_token: ÑĞ±Ğ¾Ğ¹ %s", e)
        return False


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ get_pipeline_stages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def get_pipeline_stages() -> Dict[str, str]:
    """IDâ€‘â†’â€‘ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² Ğ²ÑĞµÑ… Ğ²Ğ¾Ñ€Ğ¾Ğ½Ğ¾Ğº."""
    try:
        if not await ensure_valid_token():
            return {}

        async with aiohttp.ClientSession() as s:
            head = {"Authorization": f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"}
            async with s.get(f"https://{bot_data.config['domain']}/api/v4/leads/pipelines",
                             headers=head) as r:
                if r.status != 200:
                    logger.error("[6.0] get_pipeline_stages: HTTP %d", r.status)
                    return {}
                js = await r.json()
                stages = {
                    str(st["id"]): st["name"]
                    for pl in js["_embedded"]["pipelines"]
                    for st in pl["_embedded"]["statuses"]
                }
                logger.debug("[6.0] get_pipeline_stages: %d ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²", len(stages))
                return stages
    except Exception as e:
        logger.exception("[6.0] get_pipeline_stages: Ğ¾ÑˆĞ¸Ğ±ĞºĞ° %s", e)
        return {}


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ get_custom_fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def get_custom_fields() -> Dict[str, str]:
    """IDâ€‘â†’â€‘ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²ÑĞµÑ… ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹ ÑĞ´ĞµĞ»Ğ¾Ğº."""
    try:
        if not await ensure_valid_token():
            return {}

        async with aiohttp.ClientSession() as s:
            head = {"Authorization": f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"}
            async with s.get(f"https://{bot_data.config['domain']}/api/v4/leads/custom_fields",
                             headers=head) as r:
                if r.status != 200:
                    logger.error("[6.0] get_custom_fields: HTTP %d", r.status)
                    return {}
                js = await r.json()
                fields = {str(f["id"]): f["name"] for f in js["_embedded"]["custom_fields"]}
                logger.debug("[6.0] get_custom_fields: %d Ğ¿Ğ¾Ğ»ĞµĞ¹", len(fields))
                return fields
    except Exception as e:
        logger.exception("[6.0] get_custom_fields: Ğ¾ÑˆĞ¸Ğ±ĞºĞ° %s", e)
        return {}


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ fetch_amocrm_deals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def fetch_amocrm_deals(spreadsheet_id: str) -> List[Dict]:
    """Ğ¥Ğ¾Ğ´Ğ¸Ñ‚ Ğ² AmoCRM, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ´ĞµĞ»ĞºĞ¸."""
    try:
        if not bot_data.config or not await ensure_valid_token():
            return []

        custom_fields, stages = await asyncio.gather(
            get_custom_fields(), get_pipeline_stages()
        )
        if not custom_fields or not stages:
            return []

        # ğŸ‘‰ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID Ğ¿Ğ¾Ğ»Ñ Â«ĞŸÑ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°Â»
        global PREPAYMENT_FIELD_ID
        PREPAYMENT_FIELD_ID = next(
            (fid for fid, name in custom_fields.items() if "Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚" in name.lower()),
            None
        )

        deals: List[Dict] = []
        page, limit = 1, 250
        updated_from = int((datetime.now() - timedelta(days=DATE_FILTER_DAYS)).timestamp())
        pipeline_id = bot_data.config.get("pipeline_id")  # Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ None

        async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=20)) as s:
            head = {"Authorization": f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"}

            while True:
                params: Dict[str, Union[str, int]] = {
                    "with": "contacts,tags",
                    "limit": limit,
                    "page": page,
                    "filter[updated_at][from]": updated_from,
                }
                # Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ None â†’ Ğ¸Ğ½Ğ°Ñ‡Ğµ TypeError inside yarl
                if pipeline_id:
                    params["filter[pipeline_id]"] = pipeline_id

                # ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ğ¿ĞµÑ€ĞµÑ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² (ĞºĞ°Ğº Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‡ĞµĞ¹ 12.90)
                for i, sid in enumerate(ALLOWED_STATUS_IDS):
                    params[f"filter[statuses][{i}][pipeline_id][0][statuses][0]"] = sid

                async with s.get(f"https://{bot_data.config['domain']}/api/v4/leads",
                                 headers=head, params=params) as r:
                    logger.debug("[6.0] fetch_amocrm_deals: p.%d http=%d", page, r.status)

                    if r.status == 204:
                        break
                    if r.status == 401 and await refresh_amocrm_token():
                        head["Authorization"] = (
                            f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"
                        )
                        continue
                    if r.status != 200:
                        logger.error("[6.0] fetch_amocrm_deals: HTTP %d â€“ %s",
                                     r.status, await r.text())
                        return []

                    js = await r.json()
                    leads = js.get("_embedded", {}).get("leads", [])
                    if not leads:
                        break

                    for raw in leads:
                        if str(raw.get("status_id")) in ALLOWED_STATUS_IDS:
                            processed = await process_deal(raw, stages, custom_fields, spreadsheet_id)
                            if processed:
                                deals.append(processed)

                    page += 1
                    await asyncio.sleep(1)  # softâ€‘limit

        deals.sort(key=lambda d: d["event_datetime"])
        logger.info("[6.0] fetch_amocrm_deals: %d ÑĞ´ĞµĞ»Ğ¾Ğº", len(deals))
        return deals

    except Exception as e:
        logger.exception("[6.0] fetch_amocrm_deals: ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° %s", e)
        return []


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ get_amocrm_deals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def get_amocrm_deals(spreadsheet_id: str, refresh: bool = False) -> List[Dict]:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ¸Ğ· ĞºÑÑˆĞ° Ğ»Ğ¸Ğ±Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ĞºÑÑˆ Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸."""
    try:
        cache_key = f"deals_{spreadsheet_id}"
        cache_entry = bot_data.deals_cache.get(cache_key)
        if cache_entry and not refresh:
            age = datetime.now() - cache_entry["timestamp"]
            if age < CACHE_LIFETIME:
                logger.debug("[6.0] dealsâ€‘cache HIT | %s | age %.1fs", spreadsheet_id, age.total_seconds())
                return cache_entry["deals"]

        deals = await fetch_amocrm_deals(spreadsheet_id)
        bot_data.deals_cache[cache_key] = {"deals": deals, "timestamp": datetime.now()}
        logger.debug("[6.0] dealsâ€‘cache Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½ | %s | %d ÑĞ´ĞµĞ»Ğ¾Ğº", spreadsheet_id, len(deals))
        return deals
    except Exception as e:
        logger.exception("[6.0] get_amocrm_deals: Ğ¾ÑˆĞ¸Ğ±ĞºĞ° %s", e)
        return []


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ update_amocrm_tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def update_amocrm_tags(deal_id: int, tags: List[str]) -> bool:
    """ĞŸĞ°Ñ‚Ñ‡Ğ¸Ñ‚ Ñ‚ĞµĞ³Ğ¸ ÑĞ´ĞµĞ»ĞºĞ¸.  True â†’ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾."""
    try:
        if not await ensure_valid_token():
            return False

        async with aiohttp.ClientSession() as s:
            head = {"Authorization": f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"}
            payload = {"_embedded": {"tags": [{"name": t} for t in tags]}}

            async with s.patch(f"https://{bot_data.config['domain']}/api/v4/leads/{deal_id}",
                               headers=head, json=payload) as r:
                if r.status == 429:
                    await asyncio.sleep(1)
                    async with s.patch(f"https://{bot_data.config['domain']}/api/v4/leads/{deal_id}",
                                       headers=head, json=payload) as r2:
                        r = r2  # Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚

                if r.status != 200:
                    logger.error("[6.0] update_amocrm_tags: HTTP %d â€“ %s", r.status, await r.text())
                    return False

                logger.info("[6.0] update_amocrm_tags: ok deal=%d %s", deal_id, tags)
                return True
    except Exception as e:
        logger.exception("[6.0] update_amocrm_tags: Ğ¾ÑˆĞ¸Ğ±ĞºĞ° %s", e)
        return False

# version: 2.3
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 2.0 (12.05.2025): Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ, Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³.
# - 2.1 (13.05.2025): Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº.
# - 2.2 (14.05.2025): Ñ„Ğ¸ĞºÑÑ‹ JSONâ€‘decode Ğ¸ rateâ€‘limit.
# - 2.3 (15.05.2025): Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½ pipeline_id=None, ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒÑÑ‚ÑÑ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ â€”
#                    ÑƒÑÑ‚Ñ€Ğ°Ğ½Ñ‘Ğ½ TypeError Â«Invalid variable typeÂ» Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ.

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                   [7.0] ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… AmoCRM                           â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ¿Ñ€ĞµĞ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Â«ÑÑ‹Ñ€ÑƒÑÂ» ÑĞ´ĞµĞ»ĞºÑƒ Ğ¸Ğ· AmoCRM Ğ² ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ dict Ğ´Ğ»Ñ Ğ±Ğ¾Ñ‚Ğ°.
#           â€¢ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ Â«Ğ”Ğ¾Ğ¿. ÑƒÑĞ»ÑƒĞ³Ğ¸Â»
#           â€¢ ĞŸĞ¾Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Unix-Ñ‚Ğ°Ğ¹Ğ¼ÑÑ‚Ğ°Ğ¼Ğ¿ (ÑĞµĞº/Ğ¼Ñ) Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹ Ğ´Ğ°Ñ‚Ñ‹/Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
#           â€¢ Ğ’ÑĞµĞ³Ğ´Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ event_time (ÑÑ‚Ñ€Ğ¾ĞºĞ° Â«HH:MMÂ»)
#           â€¢ Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
# version: 2.8 (13.05.2025) â€” ÑĞ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ²

def _parse_event_datetime(raw_date: Any, raw_time: Any) -> Optional[datetime]:
    """
    Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€ÑĞµÑ€ Ğ´Ğ°Ñ‚Ñ‹ + Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¸Ğ· AmoCRM.
    """
    try:
        ts = float(raw_date)
        if ts > 1e12:
            ts /= 1000
        return MSK_TZ.localize(datetime.fromtimestamp(int(ts)))
    except (TypeError, ValueError):
        pass

    date_str = str(raw_date or "").strip()
    time_str = str(raw_time or "").strip()
    if time_str.lower() == "Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾":
        time_str = ""
    candidate = f"{date_str} {time_str}".strip()

    for fmt in (
        "%Y-%m-%d %H:%M", "%d.%m.%Y %H:%M",
        "%d/%m/%Y %H:%M", "%Y.%m.%d %H:%M",
        "%Y-%m-%d",      "%d.%m.%Y",
        "%d/%m/%Y",      "%Y.%m.%d"
    ):
        try:
            dt = datetime.strptime(candidate, fmt)
            if " %H:%M" not in fmt:
                dt = dt.replace(hour=0, minute=0)
            return MSK_TZ.localize(dt)
        except ValueError:
            continue

    return None


async def process_deal(
    deal: Dict,
    stages: Dict[str, str],
    custom_fields: Dict[str, str],
    spreadsheet_id: str,
) -> Optional[Dict]:
    """
    ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ Â«ÑÑ‹Ñ€ÑƒÑÂ» ÑĞ´ĞµĞ»ĞºÑƒ AmoCRM Ğ² ÑƒĞ½Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ dict.
    """
    deal_id = deal.get("id")
    if not deal_id:
        logger.warning("[7.0] process_deal: Ğ½ĞµÑ‚ id ÑĞ´ĞµĞ»ĞºĞ¸")
        return None

    logger.info("[7.0] process_deal START deal_id=%s", deal_id)

    try:
        # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ custom_fields_values
        cf_raw = deal.get("custom_fields_values") or []
        cf: Dict[str, List[Any]] = {
            str(f.get("field_id")): [v["value"] for v in f.get("values", []) if v.get("value") is not None]
            for f in cf_raw
        }

        # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ
        raw_date = cf.get(AMOCRM_FIELDS["event_date"], [None])[0]
        raw_time = cf.get(AMOCRM_FIELDS["event_time"], [""])[0]
        event_dt = _parse_event_datetime(raw_date, raw_time)
        if not event_dt:
            logger.error("[7.0] process_deal: Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°ÑĞ¿Ğ°Ñ€ÑĞ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ deal_id=%s", deal_id)
            return None
        event_time = (str(raw_time).strip()
                      if raw_time and str(raw_time).strip().lower() != "Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾"
                      else event_dt.strftime("%H:%M"))

        # Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹
        def to_int(val, default=0):
            try:
                return int(float(str(val).replace(",", ".")))
            except (TypeError, ValueError):
                return default

        total_budget = deal.get("price", 0)
        prepayment   = to_int(cf.get(AMOCRM_FIELDS["prepayment"], [0])[0])
        to_calculate = total_budget - prepayment

        # Ğ’ĞµĞ´ÑƒÑ‰Ğ¸Ğµ
        leads_raw = cf.get(AMOCRM_FIELDS["team_leads"], [])
        team_leads = [
            {"id": lid, "name": get_lead_name(lid)}
            for lid in map(str, leads_raw) if lid.strip()
        ]

        # Ğ”Ğ¾Ğ¿. ÑƒÑĞ»ÑƒĞ³Ğ¸
        pinata_list    = cf.get(AMOCRM_FIELDS["extra_services"], [])  # Â«ĞŸĞ¸Ğ½ÑŒÑÑ‚Ğ° Ğ² Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾ĞºÂ»
        other_services = cf.get("413875", [])  # Â«Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Â»
        all_services   = pinata_list + other_services
        extra_services = ", ".join(map(str, all_services)) if all_services else ""

        # ĞŸĞ°ĞºĞµÑ‚ ÑƒÑĞ»ÑƒĞ³
        package_list = cf.get(AMOCRM_FIELDS["package"], [""])
        package = str(package_list[0]) if package_list else ""

        # ĞŸÑ€Ğ¾Ñ‡Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ñ
        game_name    = cf.get(AMOCRM_FIELDS["game_name"], [""])[0]
        players      = cf.get(AMOCRM_FIELDS["players"], [""])[0]
        age          = cf.get(AMOCRM_FIELDS["age"], [""])[0]
        comment      = cf.get(AMOCRM_FIELDS["comment"], [""])[0] or ""
        photographer = cf.get(AMOCRM_FIELDS["photographer"], [""])[0] or ""

        processed = {
            "id":                 deal_id,
            "name":               deal.get("name", f"Ğ¡Ğ´ĞµĞ»ĞºĞ° {deal_id}"),
            "game_name":          game_name,
            "status_id":          str(deal.get("status_id", "")),
            "status":             stages.get(str(deal.get("status_id", "")), "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾"),
            "event_datetime":     event_dt,
            "event_datetime_str": f"{event_dt.strftime('%d.%m.%Y')}, {event_time}",
            "event_time":         event_time,
            "players":            players,
            "players_count":      parse_players_count(players),
            "age":                age,
            "package":            package,
            "extra_services":     extra_services,
            "comment":            comment,
            "total_budget":       total_budget,
            "prepayment":         prepayment,
            "to_calculate":       to_calculate,
            "team_leads":         team_leads,
            "photographer":       photographer,
        }

        logger.info("[7.0] process_deal DONE deal_id=%s", deal_id)
        return processed

    except Exception as e:
        logger.exception("[7.0] process_deal: Ğ¾ÑˆĞ¸Ğ±ĞºĞ° deal_id=%s: %s", deal_id, e)
        return None


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                    [8.0] ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ                          â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÑ… Ğ¸Ğ· SQLite (checklists.db).
# version: 1.3

def get_user_info(user_id: int) -> Optional[Dict]:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ Ğ¸Ğ· SQLite.

    Args:
        user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.

    Returns:
        Optional[Dict]: {
            first_name: str,
            last_name_initial: str,
            role: str,
            status: str,
            games_last_30_days: int
        } Ğ¸Ğ»Ğ¸ None, ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.
    """
    try:
        import sqlite3

        db_path = os.path.join(BASE_DIR, "checklists.db")
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT first_name, last_name, role FROM users WHERE user_id = ?",
            (user_id,)
        )
        row = cursor.fetchone()
        conn.close()

        if not row:
            logger.warning("[8.0] get_user_info: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ %d Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ %s", user_id, db_path)
            return None

        first_name, last_name, role = row
        last_initial = last_name[0] if last_name else ""
        user_data = {
            "first_name": first_name or "",
            "last_name_initial": last_initial,
            "role": role or "",
            "status": "green",
            "games_last_30_days": 0
        }
        logger.debug("[8.0] get_user_info: Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ '%s' Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ %d", role, user_id)
        return user_data

    except Exception as e:
        logger.error("[8.0] get_user_info: ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ»Ñ %d: %s", user_id, e, exc_info=True)
        return None

def get_lead_name(lead_id: str) -> str:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¸Ğ¼Ñ Ğ²ĞµĞ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾ ID.

    Args:
        lead_id: ID Ğ²ĞµĞ´ÑƒÑ‰ĞµĞ³Ğ¾.

    Returns:
        str: Ğ˜Ğ¼Ñ Ğ²ĞµĞ´ÑƒÑ‰ĞµĞ³Ğ¾.
    """
    try:
        logger.debug("[8.0] get_lead_name: Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑˆĞµĞ½Ğ¾ Ğ¸Ğ¼Ñ Ğ´Ğ»Ñ lead_id %s", lead_id)
        return "Unknown Lead"
    except Exception as e:
        logger.error("[8.0] get_lead_name: ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ»Ñ lead_id %s: %s", lead_id, e, exc_info=True)
        return "Unknown Lead"

# version: 1.3
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 1.0: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ¸.
# - 1.1 (11.05.2025): Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ¼.
# - 1.2 (12.05.2025): Ğ ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ»Ğ¸ Ñ€Ğ¾Ğ»ÑŒ Â«Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒÂ» Ğ´Ğ»Ñ LEADER_ID.
# - 1.3 (12.05.2025): ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ±Ğ°Ğ·Ğµ checklists.db Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ first_name, last_name Ğ¸ role.

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                        [9.0] ĞœĞ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…                               â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ° Ğ´Ğ»Ñ pipeline Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ².
# version: 1.1

async def generate_name_mapping() -> None:
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ pipeline Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²."""
    try:
        bot_data.pipeline_mapping = {
            "pipeline_id": {
                "name": "Main Pipeline",
                "stages": {
                    "142": "New",
                    "18913933": "In Progress",
                    "18913930": "Successful"
                }
            }
        }
        logger.info("[9.0] generate_name_mapping: ĞœĞ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ pipeline ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½")
    except Exception as e:
        logger.error("[9.0] generate_name_mapping: ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ°: %s", e, exc_info=True)
        
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                  [10.0] ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Telegram-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹                      â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ¾Ğµ Ğ¼ĞµĞ½Ñ, Â«ĞĞ¾Ğ²Ñ‹Ğµ / Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹Â» Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°.
# version: 1.9 (07.06.2025)  â€” Ñ„Ğ¸ĞºÑ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ 100 ÑĞ¸Ğ¼Ğ². Ğ½Ğ° Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°

from aiogram.types import ReplyKeyboardRemove
router = Router()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@router.message(CommandStart())
async def start_handler(message: types.Message) -> None:
    """/start â€” Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ· Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµĞ½Ñ."""
    user_id = message.from_user.id
    try:
        first_name = message.from_user.first_name or "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ"
        kb = await get_main_menu(user_id)
        txt = (
            f"ğŸ‰ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {first_name}! Ğ¯ MasterBot {VERSION} ğŸ¤–\n"
            f"Ğ¢Ğ²Ğ¾Ğ¹ ID: {user_id}\n"
        )
        txt += (
            "Ğš ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, Ñƒ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹."
            if not kb else "Ğ¯ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ñ… Ğ½Ğ° ĞºĞ²ĞµÑÑ‚Ñ‹."
        )
        await message.answer(txt, reply_markup=kb or ReplyKeyboardRemove())
        logger.info("[10.0] start_handler: user=%d name=%s", user_id, first_name)
    except Exception as e:
        logger.error("[10.0] start_handler: %s", e, exc_info=True)
        await message.answer(
            "âš ï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.",
            reply_markup=ReplyKeyboardRemove()
        )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ“… ĞĞ¾Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@router.message(lambda m: m.text and m.text.strip() in {"ğŸ“… ĞĞ¾Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹", "\U0001F4C5 ĞĞ¾Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹"})
async def new_games_handler(message: types.Message) -> None:
    user_id = message.from_user.id
    ui = get_user_info(user_id)

    if not ui or ui["role"] not in ACCESS["games"]:
        await message.answer("â›” ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.", reply_markup=await get_main_menu(user_id))
        return

    await show_games(
        message=message,
        user_id=user_id,
        status_ids=NEW_GAMES_STATUS_IDS,
        title="ğŸ“… ĞĞ¾Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹:",
        only_unassigned=True
    )
    logger.info("[10.0] new_games_handler: ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ³Ñ€ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ %d", user_id)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ âœ… Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@router.message(lambda m: m.text and m.text.strip() == "âœ… Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹")
async def assigned_games_handler(message: types.Message) -> None:
    user_id = message.from_user.id
    ui = get_user_info(user_id)

    if not ui or ui["role"] not in ACCESS["games"]:
        await message.answer("â›” ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.", reply_markup=await get_main_menu(user_id))
        return

    await show_games(
        message=message,
        user_id=user_id,
        status_ids=[SUCCESSFUL_STATUS_ID],
        title="âœ… Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹:"
    )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ“‹ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ¿Ñ€Ğ¾Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@router.message(lambda m: m.text and m.text.strip() == "ğŸ“‹ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ¿Ñ€Ğ¾Ñ")
async def create_poll_handler(message: types.Message) -> None:
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ğ¾ Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¼ 14 Ğ´Ğ½ÑĞ¼ Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´-Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚."""
    user_id = message.from_user.id

    # â”€â”€ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if not await has_access(user_id, "poll"):
        await message.answer("â›” ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.", reply_markup=await get_main_menu(user_id))
        return
    if bot_data.coordination_cycle_active:
        await message.answer("âš ï¸ Ğ£Ğ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¾Ğ¿Ñ€Ğ¾Ñ.")
        return
    if not bot_data.admin_chat_id or not await is_bot_admin(bot_data.admin_chat_id):
        await message.answer("âš ï¸ Ğ§Ğ°Ñ‚ Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ñ… Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ±Ğ¾Ñ‚ Ğ½Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½.")
        return
    sid = bot_data.config.get("svetofor_spread_id")
    if not sid:
        await message.answer("âš ï¸ ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ ID Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Â«Ğ¡Ğ²ĞµÑ‚Ğ¾Ñ„Ğ¾Ñ€Â».")
        return
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    deals = await get_amocrm_deals(sid)
    now, window_end = datetime.now(tz=MSK_TZ), datetime.now(tz=MSK_TZ) + timedelta(days=14)
    poll_deals = [
        d for d in deals
        if d["status_id"] in NEW_GAMES_STATUS_IDS
        and now <= d["event_datetime"] <= window_end
        and not d["team_leads"]
    ]
    if not poll_deals:
        await message.answer("ğŸ˜” ĞĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… Ğ¸Ğ³Ñ€ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°.",
                             reply_markup=await get_main_menu(user_id))
        return

    # â”€â”€ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    poll_deals.sort(key=lambda x: x["event_datetime"])
    bot_data.current_poll_deals       = poll_deals
    bot_data.current_poll_leader      = user_id
    bot_data.responses.clear()
    bot_data.coordination_cycle_active = True
    # -------------------------------------------------------------------

    chunks      = [poll_deals[i:i + 8] for i in range(0, len(poll_deals), 8)]
    urgent      = any(d["event_datetime"] <= now + timedelta(days=3) for d in poll_deals)
    base_header = "ğŸš¨ Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹!" if urgent else "ğŸ“Š ĞĞ¾Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹"

    for idx, chunk in enumerate(chunks, 1):
        header  = f"{base_header} (Ğ§Ğ°ÑÑ‚ÑŒ {idx})" if len(chunks) > 1 else base_header
        options, indices = [], {}

        for i, d in enumerate(chunk):
            date = d["event_datetime"].strftime("%d.%m")

            # â”€â”€ Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° â‰¤ 100 ÑĞ¸Ğ¼Ğ². â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            text = f"ğŸ‰ {d['name']} â€“ {date}"
            if d["package"]:
                text = f"{text} â€“ {d['package']}"

            if d["extra_services"]:
                rest = 100 - len(text) - 1          # +1 Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ±ĞµĞ» Ğ¿ĞµÑ€ĞµĞ´ ÑƒÑĞ»ÑƒĞ³Ğ°Ğ¼Ğ¸
                if rest > 0:
                    extra = d["extra_services"]
                    if len(extra) > rest:
                        extra = extra[:rest - 1].rstrip(", ") + "â€¦"
                    text = f"{text} {extra}"

            if len(text) > 100:                     # ÑÑ‚Ñ€Ğ°Ñ…Ğ¾Ğ²ĞºĞ°
                text = text[:97].rstrip(", ") + "â€¦"
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            options.append(text)
            indices[i] = d["id"]

        options += ["ğŸš« ĞĞµ ÑĞ¼Ğ¾Ğ³Ñƒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ", "ğŸ›¡ï¸ ĞœĞ¾Ğ³Ñƒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼"]

        poll_msg = await bot.send_poll(
            bot_data.admin_chat_id,
            header,
            options,
            is_anonymous=False,
            allows_multiple_answers=True
        )
        bot_data.responses[poll_msg.poll.id] = {
            "deals": {d["id"]: [] for d in chunk},
            "admin_available": [],
            "not_available": [],
            "deal_indices": indices
        }

    # â”€â”€ Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    report_text = await generate_poll_report()

    dash_msg = await bot.send_message(
        user_id,
        report_text,
        reply_markup=bot_data.distribution_keyboard,
        parse_mode="Markdown"
    )
    bot_data.personal_report_message_id = dash_msg.message_id

    # Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
    await bot.send_message(
        user_id,
        "â„¹ï¸ Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ñ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ¼:",
        reply_markup=get_distribution_keyboard()
    )

    await report_unknown_names()

    # â”€â”€ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡ĞµÑ€ĞµĞ· 24 Ñ‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    scheduler.add_job(
        clear_poll_data,
        "date",
        run_date=now + POLL_DURATION,
        args=[user_id],
        id=f"clear_poll_{user_id}",
        replace_existing=True
    )

    await message.answer("âœ… ĞĞ¿Ñ€Ğ¾ÑÑ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹.", reply_markup=await get_main_menu(user_id))
    logger.info("[10.0] create_poll_handler: polls for %d deals", len(poll_deals))



# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                      [11.0] Callback-Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸                          â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback c.data="game_details_<id>" â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸,
# Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Â«ĞŸĞ°ĞºĞµÑ‚ ÑƒÑĞ»ÑƒĞ³Â» Ğ¸ Â«Ğ”Ğ¾Ğ¿. ÑƒÑĞ»ÑƒĞ³Ğ¸Â».
# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğº ÑĞ¿Ğ¸ÑĞºÑƒ Ğ¸Ğ³Ñ€.
@router.callback_query(lambda c: c.data.startswith("game_details_"))
async def game_details_handler(callback: types.CallbackQuery) -> None:
    user_id = callback.from_user.id
    deal_id = int(callback.data.split("_")[-1])
    try:
        # Ğ¿Ğ¾Ğ¸ÑĞº ÑĞ´ĞµĞ»ĞºĞ¸ Ğ² ĞºÑÑˆĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ»Ğ¸ Ğ² Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ Ğ¾Ğ¿Ñ€Ğ¾ÑĞµ
        deal = next(
            (d for d in bot_data.games_by_user.get(user_id, []) if d["id"] == deal_id),
            next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        )
        if not deal:
            await callback.answer("âš ï¸ Ğ˜Ğ³Ñ€Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.", show_alert=True)
            return

        # Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ° Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
        date_part    = (deal.get("event_datetime_str") or "â€”").split(",")[0]
        time_part    = deal.get("event_time", "â€”")
        quest        = deal.get("game_name", "â€”")
        package      = deal.get("package", "â€”")
        status       = deal.get("status", "â€”")
        players      = deal.get("players", "â€”")
        age          = deal.get("age", "â€”")
        extra        = deal.get("extra_services", "â€”")
        comment      = deal.get("comment", "â€”")
        prepay       = deal.get("prepayment", 0)
        leads        = ", ".join(l.get("name", "") for l in deal.get("team_leads", [])) or "â€”"
        photographer = deal.get("photographer", "â€”")
        total_budget = deal.get("total_budget", 0)
        to_calc      = deal.get("to_calculate", 0)

        text = "\n".join([
            f"ğŸ® *Ğ˜Ğ³Ñ€Ğ°*: {quest}",
            f"ğŸ *ĞŸĞ°ĞºĞµÑ‚ ÑƒÑĞ»ÑƒĞ³*: {package}",
            f"ğŸ”– *Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ*: {status}",
            f"ğŸ“… *Ğ”Ğ°Ñ‚Ğ°*: {date_part}",
            f"ğŸ•’ *Ğ’Ñ€ĞµĞ¼Ñ*: {time_part}",
            f"ğŸ‘¥ *Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¸*: {players}",
            f"âš ï¸ *Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚*: {age}",
            f"â• *Ğ”Ğ¾Ğ¿. ÑƒÑĞ»ÑƒĞ³Ğ¸*: {extra}",
            f"ğŸ’¬ *ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹*: {comment}",
            f"ğŸ’¸ *ĞŸÑ€ĞµĞ´Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°*: {prepay} â‚½",
            f"ğŸ§‘â€ğŸ¤â€ğŸ§‘ *Ğ’ĞµĞ´ÑƒÑ‰Ğ¸Ğµ*: {leads}",
            f"ğŸ“· *Ğ¤Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„*: {photographer}",
            f"ğŸ’° *Ğ‘ÑĞ´Ğ¶ĞµÑ‚*: {total_budget} â‚½",
            f"ğŸ§® *Ğš Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñƒ*: {to_calc} â‚½",
        ])

        # ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°
        kb = InlineKeyboardBuilder()
        kb.button(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´ Ğº ÑĞ¿Ğ¸ÑĞºÑƒ", callback_data="back_to_games_list")
        kb.adjust(1)

        await callback.message.answer(text, reply_markup=kb.as_markup(), parse_mode="Markdown")
        await callback.answer()

    except Exception as e:
        await callback.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹.", show_alert=True)


@router.callback_query(lambda c: c.data == "back_to_games_list")
async def back_to_games_list_handler(callback: types.CallbackQuery) -> None:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğº ÑĞ¿Ğ¸ÑĞºÑƒ Ğ¸Ğ³Ñ€."""
    user_id = callback.from_user.id
    try:
        games = bot_data.games_by_user.get(user_id)
        if not games:
            await callback.answer("ğŸ˜” Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ³Ñ€ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½.", show_alert=True)
            return

        # Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ°
        kb = InlineKeyboardBuilder()
        for d in games:
            btn_text = f"ğŸ‰ {d['name']} {d['event_time']}"
            kb.button(text=btn_text, callback_data=f"game_details_{d['id']}")
        kb.adjust(1)

        await callback.message.answer("ğŸ“‹ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ³Ñ€:\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ñƒ:", reply_markup=kb.as_markup())
        await callback.answer()

    except Exception:
        await callback.answer("âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº ÑĞ¿Ğ¸ÑĞºÑƒ.", show_alert=True)

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                  [11.2] report_back_handler (â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´)                    â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ³Ñ€ Ğ¸Ğ· Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Â«ĞĞ°Ğ·Ğ°Ğ´Â»
# version: 1.0 (30.05.2025)

@router.callback_query(lambda c: c.data == "report_back")
async def report_back_handler(callback: types.CallbackQuery) -> None:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¸Ğ· Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° Ğ¿Ğ¾ Ğ¸Ğ³Ñ€Ğµ Ğº ÑĞ¿Ğ¸ÑĞºÑƒ Ğ¸Ğ³Ñ€-ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº."""
    try:
        await callback.message.delete()                 # ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
        # Ğ¿ĞµÑ€ĞµÑ€Ğ¸ÑĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Â«Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑÂ» ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°
        await bot.edit_message_text(
            await generate_poll_report(),
            chat_id=callback.from_user.id,
            message_id=bot_data.personal_report_message_id,
            reply_markup=bot_data.distribution_keyboard,
            parse_mode="Markdown"
        )
        await callback.answer()
    except Exception:
        # ĞµÑĞ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼
        await callback.answer()

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                          [12.0] ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹                                â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ replyâ€‘ Ğ¸ inlineâ€‘ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€ Ğ´Ğ»Ñ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼.
# version: 1.4

from typing import List, Optional
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils.keyboard import ReplyKeyboardBuilder   # aiogramÂ 3.x builder

async def get_main_menu(user_id: int) -> Optional[ReplyKeyboardMarkup]:
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ."""
    try:
        user_info = get_user_info(user_id) or {}
        role = user_info.get("role", "")

        # â€” Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº â€”
        btns: List[KeyboardButton] = []
        if role in ACCESS["games"]:
            btns.extend([
                KeyboardButton(text="\U0001F4C5 ĞĞ¾Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹"),
                KeyboardButton(text="\U00002705 Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹")
            ])
        if role in ACCESS["poll"]:
            btns.append(KeyboardButton(text="\U0001F4CB Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ¿Ñ€Ğ¾Ñ"))

        if not btns:
            logger.warning("[12.0] get_main_menu: ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Ğ´Ğ»Ñ %d, role=%s",
                           user_id, role)
            return None

        # â€” ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ‡ĞµÑ€ĞµĞ· builder â€”
        builder = ReplyKeyboardBuilder()
        builder.add(*btns)
        builder.adjust(2)                         # 2Â ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ² ÑÑ‚Ñ€Ğ¾ĞºĞµ
        markup = builder.as_markup(resize_keyboard=True)
        logger.debug("[12.0] get_main_menu: Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¼ĞµĞ½Ñ Ğ´Ğ»Ñ %d (%s), %d ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº",
                     user_id, role, len(btns))
        return markup
    except Exception as exc:
        logger.error("[12.0] get_main_menu: ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ»Ñ %d: %s", user_id, exc, exc_info=True)
        return None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 1.0Â (??.05.2025): Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ.
# - 1.1Â (11.05.2025): Ğ›Ğ¾Ğ³Ğ¸ + Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ÑƒÑÑ‚Ñ‹Ñ… ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº.
# - 1.2Â (14.05.2025): Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ReplyKeyboardMarkup.
# - 1.3Â (15.05.2025): ĞŸĞµÑ€ĞµĞ²ĞµĞ´ĞµĞ½Ğ¾ Ğ½Ğ° ReplyKeyboardBuilder.
# - 1.4Â (15.05.2025): Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ°Ğ²ĞºĞ° â€” ÑƒĞ±Ñ€Ğ°Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° Ñ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼ ReplyKeyboardMarkup.
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                     [12.1] ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ                       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ĞµĞ´Ğ¸Ğ½Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğº Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼Ñƒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ñƒ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ
#           (Â«ğŸ‘Œ Ğ£Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒÂ», Â«ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒÂ», Â«ğŸ”§ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑÂ»)
#           Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· create_poll_handler Ñ‡ĞµÑ€ĞµĞ· get_distribution_keyboard()
# version: 1.0 (30.05.2025)

def get_distribution_keyboard() -> InlineKeyboardMarkup:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¸Ğ½Ğ»Ğ°Ğ¹Ğ½-ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ½Ğ°Ğ´ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼."""
    kb = InlineKeyboardBuilder()
    kb.button(text="ğŸ‘Œ Ğ£Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ",
              callback_data="distribute_leaders")
    kb.button(text="ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² AmoCRM",
              callback_data="save_distribution")
    kb.button(text="ğŸ”§ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ¾ÑÑ‚Ğ°Ğ² Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ",
              callback_data="manual_edit")
    kb.adjust(1)          # ĞºĞ°Ğ¶Ğ´Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞµ
    return kb.as_markup()


# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆ                                                                         â–ˆ
# â–ˆ                       [13.0] generate_poll_report                        â–ˆ
# â–ˆ                                                                         â–ˆ
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Â«Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Â»-Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ.
#           Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ ĞºĞ½Ğ¾Ğ¿ĞºĞ°-ÑÑ‚Ñ€Ğ¾ĞºĞ° Ğ²Ğ¸Ğ´Ğ°
#           âœ… ĞšĞ²ĞµÑÑ‚ â€” DD.MM   Ğ¸Ğ»Ğ¸   âŒ ĞšĞ²ĞµÑÑ‚ â€” DD.MM
#           Ğ“Ğ°Ğ»Ğ¾Ñ‡ĞºĞ° ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑÑ, ĞµÑĞ»Ğ¸ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¾ÑÑ‚Ğ°Ğ² ÑĞ¾Ğ±Ñ€Ğ°Ğ½.
#           ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² bot_data.distribution_keyboard.
# version: 6.1 (30.05.2025)

from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

async def generate_poll_report() -> str:
    logger.debug("[13.0] generate_poll_report: start")

    # Ğ•ÑĞ»Ğ¸ Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑ‚ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ¾Ğ² â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼
    if not bot_data.current_poll_deals or not bot_data.responses:
        return "âš ï¸ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²."

    keyboard: list[list[InlineKeyboardButton]] = []

    for deal in bot_data.current_poll_deals:
        deal_id   = deal["id"]
        name      = deal.get("game_name", "â€”")
        date_str  = deal["event_datetime"].strftime("%d.%m")
        pkg_lower = (deal.get("package") or "").strip().lower()

        # Ğ¢Ñ€ĞµĞ±ÑƒĞµĞ¼Ñ‹Ğµ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾ ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ğµ
        role_def    = GAME_ROLE_MAPPING.get(name, {"main_leaders": 1, "assistants": 0})
        need_main   = role_def["main_leaders"]
        need_assist = role_def["assistants"]
        need_admin  = 1 if pkg_lower in ("ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚", "ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚+", "Ğ¿Ñ€ĞµĞ¼Ğ¸ÑƒĞ¼", "vip", "Ğ²Ğ¸Ğ¿") else 0

        # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµÑ…, ĞºÑ‚Ğ¾ Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ½ÑƒĞ»ÑÑ Ğ½Ğ° ÑÑ‚Ñƒ Ğ¸Ğ³Ñ€Ñƒ
        respondents: list[dict] = []
        for poll_data in bot_data.responses.values():
            respondents += poll_data["deals"].get(deal_id, [])

        # Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·ĞµĞ»ĞµĞ½Ñ‹Ñ…/Ğ¶ĞµĞ»Ñ‚Ñ‹Ñ…/Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ñ… Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ¾Ğ²
        have_main = have_assist = have_admin = 0
        for u in respondents:
            status = await get_user_status_from_svetofor(u["user_id"], name)
            if status == "green":
                have_main += 1
                have_assist += 1  # Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹ Ğ³Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ¸ ĞºĞ°Ğº Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº
            elif status == "yellow":
                have_assist += 1
            if u.get("is_admin_eligible"):
                have_admin += 1

        ready = (
            have_main   >= need_main and
            have_assist >= need_assist and
            have_admin  >= need_admin
        )
        icon = "âœ…" if ready else "âŒ"
        btn_text = f"{icon} {name} â€” {date_str}"

        keyboard.append([
            InlineKeyboardButton(text=btn_text, callback_data=f"show_deal_{deal_id}")
        ])

    bot_data.distribution_keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard)
    return "ğŸ“Š *ĞĞ¿Ñ€Ğ¾Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ñƒ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ°:*"


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                 [13.0.1] show_deal_callback_handler                       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ğµ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ½Ñ‹
# version: 1.0 (28.05.2025)

@router.callback_query(lambda c: c.data.startswith("show_deal_"))
async def show_deal_callback_handler(callback: types.CallbackQuery) -> None:
    try:
        deal_id = int(callback.data.split("_")[-1])
        deal = next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        if not deal:
            await callback.answer("âš ï¸ Ğ˜Ğ³Ñ€Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.", show_alert=True)
            return

        game = deal["game_name"]
        game_l = game.lower()
        date = deal["event_datetime"].strftime("%d.%m.%Y")
        time = deal["event_time"]
        pkg = (deal.get("package") or "").strip()
        pkg_lower = pkg.lower()
        players = parse_players_count(deal.get("players", 0))
        pkg_emoji = {
            "ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚": "ğŸ’", "ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚": "ğŸ“¦", "ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚+": "ğŸ“¦â•",
            "Ğ¿Ñ€ĞµĞ¼Ğ¸ÑƒĞ¼": "ğŸ’", "Ğ²Ğ¸Ğ¿": "ğŸ‘‘", "vip": "ğŸ‘‘"
        }.get(pkg_lower, "ğŸ")

        role_def = GAME_ROLE_MAPPING.get(game, {"main_leaders": 1, "assistants": 0})
        need_main = role_def["main_leaders"]
        need_assist = role_def["assistants"]
        need_admin = 1 if pkg_lower in ("ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚", "ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚+", "Ğ¿Ñ€ĞµĞ¼Ğ¸ÑƒĞ¼", "vip", "Ğ²Ğ¸Ğ¿") else 0

        respondents = []
        for data in bot_data.responses.values():
            respondents += data["deals"].get(deal_id, [])

        used_ids = set()
        kb = InlineKeyboardBuilder()
        lines = [
            f"ğŸ® *Ğ˜Ğ³Ñ€Ğ°:* {game}",
            f"ğŸ“… *Ğ”Ğ°Ñ‚Ğ°:* {date}",
            f"ğŸ•’ *Ğ’Ñ€ĞµĞ¼Ñ:* {time}",
            f"ğŸ“¦ *ĞŸĞ°ĞºĞµÑ‚:* {pkg_emoji} {pkg or 'â€”'}",
            f"ğŸ‘¥ *Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¸:* {players}",
        ]

        async def role_block(label: str, role_type: str, required: int):
            nonlocal kb
            result = []
            selected, alt = [], []
            for u in respondents:
                if u["user_id"] in used_ids:
                    continue
                status = await get_user_status_from_svetofor(u["user_id"], game)
                if role_type == "main" and status == "green":
                    (selected if len(selected) < required else alt).append((u, status))
                elif role_type == "assist" and status in ("green", "yellow"):
                    (selected if len(selected) < required else alt).append((u, status))
                elif role_type == "admin" and u.get("is_admin_eligible"):
                    (selected if len(selected) < required else alt).append((u, "ğŸ›¡ï¸"))

            icon = {"main": "ğŸ§­", "assist": "ğŸ›Ÿ", "admin": "ğŸ›¡ï¸"}[role_type]
            result.append(f"\nâ”€â”€â”€â”€â”€ {icon} *{label.upper()}* â”€â”€â”€â”€â”€")
            result.append(f"âœ… {len(selected)}/{required}")
            if not selected:
                result.append("â€“ â€”")
            for u, st in selected:
                used_ids.add(u["user_id"])
                name = f"{u['first_name']} {u['last_name_initial']}"
                result.append(f"â€“ {name} {st if st in ['ğŸ›¡ï¸'] else 'ğŸŸ¢' if st == 'green' else 'ğŸŸ¡'}")

            if alt:
                result.append("ğŸ” *ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ°:*")
                for u, st in alt:
                    name = f"{u['first_name']} {u['last_name_initial']}"
                    btn = InlineKeyboardButton(
                        text=f"{name} {st if st in ['ğŸ›¡ï¸'] else 'ğŸŸ¢' if st == 'green' else 'ğŸŸ¡'}",
                        callback_data=f"swap_{deal_id}_{role_type}_{u['user_id']}"
                    )
                    kb.row(btn)

            return result

        lines += await role_block("Ğ’ĞµĞ´ÑƒÑ‰Ğ¸Ğµ", "main", need_main)
        lines += await role_block("ĞŸĞ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ¸", "assist", need_assist)
        lines += await role_block("ĞĞ´Ğ¼Ğ¸Ğ½", "admin", need_admin)

        kb.row(
            InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="report_back")
        )
        await callback.message.answer("\n".join(lines), reply_markup=kb.as_markup(), parse_mode="Markdown")
        await callback.answer()

    except Exception as e:
        logger.error("[13.0.1] show_deal_callback_handler: %s", e, exc_info=True)
        await callback.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¸ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°.", show_alert=True)
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                      [13.0.1.1] assign_swap_handler                       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ĞœĞµĞ½ÑĞµÑ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ñ€Ğ¾Ğ»Ğ¸ (Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ğ¹, Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº, Ğ°Ğ´Ğ¼Ğ¸Ğ½)
# version: 1.0 (28.05.2025)

@router.callback_query(lambda c: c.data.startswith("swap_"))
async def assign_swap_handler(callback: types.CallbackQuery) -> None:
    try:
        _, deal_id_str, role_type, new_user_id_str = callback.data.split("_")
        deal_id = int(deal_id_str)
        new_user_id = int(new_user_id_str)

        deal = next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        if not deal:
            await callback.answer("âš ï¸ Ğ˜Ğ³Ñ€Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.", show_alert=True)
            return

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ğ² Ğ½Ğ° ÑÑ‚Ñƒ Ñ€Ğ¾Ğ»ÑŒ
        role_prefix = {
            "main": "lead",
            "assist": "assistant",
            "admin": "admin"
        }[role_type]

        # Ğ˜Ñ‰ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° Ğ½Ğ° ÑÑ‚Ğ¾Ğ¹ Ñ€Ğ¾Ğ»Ğ¸
        dist = bot_data.distribution_cache.get(str(deal_id), {})
        current_key = next((k for k in dist if k.startswith(role_prefix)), None)
        if not current_key:
            await callback.answer("âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ€Ğ¾Ğ»ÑŒ.", show_alert=True)
            return

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°
        user_info = get_user_info(new_user_id)
        if not user_info:
            await callback.answer("âš ï¸ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.", show_alert=True)
            return

        name = f"{user_info['first_name']} {user_info['last_name_initial']}"
        suffix = {
            "lead": ".1", "assistant": ".ĞŸĞ¾Ğ¼", "admin": ".ĞĞ´"
        }.get(role_prefix, "")

        tag = f"{name}{suffix}"

        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ
        dist[current_key] = tag
        bot_data.distribution_cache[str(deal_id)] = dist

        await callback.answer("âœ… ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾.")
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ñ‹
        await show_deal_callback_handler(callback)

    except Exception as e:
        logger.error("[13.0.1.1] assign_swap_handler: %s", e, exc_info=True)
        await callback.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ½Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°.", show_alert=True)


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                   [13.0.2] distribute_leaders_handler                     â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ· ĞºÑÑˆĞ°
#           (Ğ½Ğµ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ Ğ½ÑƒĞ»Ñ, Ğ½Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ create_distribution)
# version: 4.0 (28.05.2025) â€” Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¸Ğ· distribution_cache

@router.callback_query(lambda c: c.data == "distribute_leaders")
async def distribute_leaders_handler(callback: types.CallbackQuery) -> None:
    user_id = callback.from_user.id
    logger.debug("[13.0.2] distribute_leaders_handler: start for user %d", user_id)

    try:
        if not await has_access(user_id, "poll"):
            await callback.answer("â›” ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.", show_alert=True)
            return
        if not bot_data.coordination_cycle_active:
            await callback.answer("âš ï¸ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°.", show_alert=True)
            return

        if not bot_data.distribution_cache:
            await callback.answer("âš ï¸ Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾.", show_alert=True)
            return

        report = ["ğŸ“‹ *ĞŸÑ€ĞµĞ´Ğ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ:*"]

        for deal in bot_data.current_poll_deals:
            did = str(deal["id"])
            dist = bot_data.distribution_cache.get(did, {})
            if not dist:
                continue

            report.append(f"\nğŸ¯ *{deal['name']}* â€” {deal['event_datetime_str']}")

            for role, tag in dist.items():
                emoji = {
                    "lead": "ğŸ§­", "assistant": "ğŸ›Ÿ", "admin": "ğŸ›¡ï¸", "intern": "ğŸ‘·"
                }.get(role.split("1")[0], "ğŸ‘¤")
                txt = tag or "_Ğ½Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½_"
                report.append(f"{emoji} {role.capitalize()}: {txt}")

        await callback.message.answer("\n".join(report), parse_mode="Markdown")
        await callback.answer()

        logger.debug("[13.0.2] distribute_leaders_handler: done")

    except Exception as e:
        logger.error("[13.0.2] distribute_leaders_handler: ĞÑˆĞ¸Ğ±ĞºĞ°: %s", e, exc_info=True)
        await callback.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ.", show_alert=True)

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘            [13.0.3] save_distribution_to_amocrm_handler (fixed)           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¸Ğ¼Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ update_amocrm_tags + Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ¾Ğ± Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
# version: 1.1 (30.05.2025)

@router.callback_query(lambda c: c.data == "save_distribution")
async def save_distribution_to_amocrm_handler(callback: types.CallbackQuery) -> None:
    user_id = callback.from_user.id
    logger.debug("[13.0.3] save_distribution_to_amocrm_handler: start for user %d", user_id)

    try:
        # Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ²
        if not await has_access(user_id, "poll"):
            await callback.answer("â›” ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.", show_alert=True)
            return

        # Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°, Ñ‡Ñ‚Ğ¾ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ÑƒĞ¶Ğµ ÑÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾
        if not bot_data.distribution_cache:
            await callback.answer("âš ï¸ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑƒÑ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ.", show_alert=True)
            return

        updates: list[str] = []

        for deal in bot_data.current_poll_deals:
            did_str = str(deal["id"])
            dist    = bot_data.distribution_cache.get(did_str, {})
            tags    = [t for t in dist.values() if t]  # Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ĞµĞ¿ÑƒÑÑ‚Ñ‹Ğµ Ñ‚ĞµĞ³Ğ¸

            if not tags:
                updates.append(f"âš ï¸ {deal['name']} â€” Ğ½ĞµÑ‚ Ñ‚ĞµĞ³Ğ¾Ğ² Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸")
                continue

            # ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² AmoCRM
            success = await update_amocrm_tags(deal_id=deal["id"], tags=tags)
            updates.append(f"{'âœ…' if success else 'âŒ'} {deal['name']}")

        report = "\n".join(updates) if updates else "âš ï¸ ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ."
        await callback.message.answer(
            f"ğŸ’¾ *Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² AmoCRM:*\n{report}",
            parse_mode="Markdown"
        )
        await callback.answer("Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾.")

        logger.info("[13.0.3] save_distribution_to_amocrm_handler: completed")

    except Exception as e:
        logger.error("[13.0.3] save_distribution_to_amocrm_handler: %s", e, exc_info=True)
        await callback.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸.", show_alert=True)


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                        [13.0.5] report_unknown_names                     â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ¡Ğ¾Ğ¾Ğ±Ñ‰Ğ°ĞµÑ‚ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÑ…, Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ñ… Ğ² Ğ±Ğ°Ğ·Ğµ.
# version: 4.9.0 (MasterBot 12.90)

async def report_unknown_names() -> None:
    logger.debug("[13.0.5] report_unknown_names: start")
    try:
        unknown = []
        for data in bot_data.responses.values():
            for deal_id, users in data["deals"].items():
                for u in users:
                    if not get_user_info(u["user_id"]):
                        unknown.append(u["first_name"])
            for u in data["admin_available"] + data["not_available"]:
                if not get_user_info(u["user_id"]):
                    unknown.append(u["first_name"])
        if unknown:
            text = "âš ï¸ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸: " + ", ".join(sorted(set(unknown)))
            await bot.send_message(bot_data.current_poll_leader, text, parse_mode="Markdown")
        logger.debug("[13.0.5] report_unknown_names: done")
    except Exception as e:
        logger.error("[13.0.5] report_unknown_names: ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¾ Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÑ…: %s", e, exc_info=True)


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                         [13.2] clear_poll_data                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ĞÑ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ñƒ.
# version: 12.90

async def clear_poll_data(user_id: int) -> None:
    logger.debug("[13.2] clear_poll_data: start for user %d", user_id)
    try:
        bot_data.responses.clear()
        bot_data.current_poll_deals.clear()
        bot_data.distribution_cache.clear()
        bot_data.personal_report_message_id = None
        bot_data.current_poll_leader = None
        bot_data.coordination_cycle_active = False
        bot_data.distribution_keyboard = None
        bot_data.current_event_period = None
        logger.info("[13.2] clear_poll_data: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ %d", user_id)
    except Exception as e:
        logger.error("[13.2] clear_poll_data: ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ %d: %s", user_id, e, exc_info=True)


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                        [13.3] handle_poll_answer                         â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# version: 2.0 (26.05.2025) â€” ÑƒĞ±Ñ€Ğ°Ğ½Ğ¾ run_until_complete, Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ async

@router.poll_answer()
async def handle_poll_answer(event: types.PollAnswer) -> None:
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ³Ğ¾Ğ»Ğ¾ÑĞ° Ğ² Telegram-Ğ¾Ğ¿Ñ€Ğ¾ÑĞµ."""
    user_id, poll_id, chosen = event.user.id, event.poll_id, event.option_ids
    logger.debug("[13.3] handle_poll_answer: start poll=%s user=%d choices=%s",
                 poll_id, user_id, chosen)

    if poll_id not in bot_data.responses:      # Ğ½Ğµ Ğ½Ğ°Ñˆ Ğ¾Ğ¿Ñ€Ğ¾Ñ
        return

    data = bot_data.responses[poll_id]

    # ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    for lst in data["deals"].values():
        lst[:] = [u for u in lst if u["user_id"] != user_id]
    data["not_available"][:]   = [u for u in data["not_available"]   if u["user_id"] != user_id]
    data["admin_available"][:] = [u for u in data["admin_available"] if u["user_id"] != user_id]

    ui        = get_user_info(user_id) or {}
    base_user = {
        "user_id": user_id,
        "first_name": ui.get("first_name", ""),
        "last_name_initial": ui.get("last_name_initial", ""),
        "is_admin_eligible": False
    }

    num_games = len(data["deal_indices"])

    for idx in chosen:
        if idx < num_games:                            # Ğ¸Ğ³Ñ€Ğ°
            did = data["deal_indices"][idx]
            data["deals"][did].append(base_user.copy())
        elif idx == num_games:                         # ğŸš«
            data["not_available"].append(base_user.copy())
        elif idx == num_games + 1:                     # ğŸ›¡ï¸
            u = base_user.copy(); u["is_admin_eligible"] = True
            data["admin_available"].append(u)

    # Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
    try:
        report = await generate_poll_report()
        await bot.edit_message_text(
            report, chat_id=bot_data.current_poll_leader,
            message_id=bot_data.personal_report_message_id,
            parse_mode="Markdown", reply_markup=bot_data.distribution_keyboard
        )
        logger.debug("[13.3] handle_poll_answer: report updated")
    except Exception as e:
        logger.error("[13.3] handle_poll_answer: %s", e, exc_info=True)

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                         [13.4] Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ°                     â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ğ¾Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ Ñ€Ğ¾Ğ»ÑĞ¼
# version: 1.0 (27.05.2025) â€” ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ½Ğ° Ğ¾Ğ´Ğ½Ñƒ Ğ¸Ğ³Ñ€Ñƒ

@router.callback_query(lambda c: c.data == "manual_edit")
async def manual_edit_menu(callback: types.CallbackQuery) -> None:
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ³Ñ€ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ°."""
    try:
        kb = InlineKeyboardBuilder()
        for deal in bot_data.current_poll_deals:
            name = deal["name"]
            date = deal["event_datetime"].strftime("%d.%m")
            kb.button(text=f"âœï¸ {name} â€” {date}", callback_data=f"edit_compact_{deal['id']}")
        kb.adjust(1)

        await callback.message.answer("ğŸ›  Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ñƒ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ°:", reply_markup=kb.as_markup())
        await callback.answer()
    except Exception as e:
        logger.error("[13.4] manual_edit_menu: %s", e, exc_info=True)
        await callback.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸Ğ³Ñ€.", show_alert=True)


@router.callback_query(lambda c: c.data.startswith("edit_compact_"))
async def edit_compact_roles(callback: types.CallbackQuery) -> None:
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾ÑÑ‚Ğ°Ğ² Ñ€Ğ¾Ğ»ĞµĞ¹ Ğ½Ğ° Ğ¾Ğ´Ğ½Ñƒ Ğ¸Ğ³Ñ€Ñƒ, ĞºĞ°Ğ¶Ğ´Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ â€” Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°."""
    try:
        deal_id = int(callback.data.split("_")[-1])
        deal = next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        if not deal:
            await callback.answer("âš ï¸ Ğ˜Ğ³Ñ€Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.", show_alert=True)
            return

        roles = bot_data.distribution_cache.get(str(deal_id), {})
        kb = InlineKeyboardBuilder()

        for role, name in roles.items():
            btn_text = f"{role.capitalize()}: {name or 'â€”'}"
            kb.button(text=btn_text, callback_data=f"select_user_{deal_id}_{role}")
        kb.adjust(1)

        await callback.message.answer(f"ğŸ›  Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² Ğ´Ğ»Ñ *{deal['name']}*:", reply_markup=kb.as_markup(), parse_mode="Markdown")
        await callback.answer()

    except Exception as e:
        logger.error("[13.4] edit_compact_roles: %s", e, exc_info=True)
        await callback.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¸ Ñ€Ğ¾Ğ»ĞµĞ¹.", show_alert=True)


@router.callback_query(lambda c: c.data.startswith("select_user_"))
async def select_user_for_role(callback: types.CallbackQuery) -> None:
    """ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ğ² Ğ½Ğ° ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½ÑƒÑ Ñ€Ğ¾Ğ»ÑŒ Ğ² Ğ¸Ğ³Ñ€Ğµ."""
    try:
        _, deal_id, role = callback.data.split("_", 2)
        deal_id = int(deal_id)
        deal = next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        if not deal:
            await callback.answer("âš ï¸ Ğ˜Ğ³Ñ€Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.", show_alert=True)
            return

        candidates = []
        for p in bot_data.responses.values():
            candidates += p["deals"].get(deal_id, [])

        # Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ñ€Ğ¾Ğ»Ğ¸
        filtered = []
        for u in candidates:
            status = await get_user_status_from_svetofor(u["user_id"], deal["game_name"])
            if role.startswith("lead") and status == "green":
                filtered.append(u)
            elif role.startswith("assistant") and status in ("green", "yellow"):
                filtered.append(u)
            elif role == "admin" and u.get("is_admin_eligible"):
                filtered.append(u)
            elif role == "intern" and status == "red":
                filtered.append(u)

        kb = InlineKeyboardBuilder()
        for u in filtered:
            name = f"{u['first_name']} {u['last_name_initial']}"
            kb.button(text=name, callback_data=f"assign_{deal_id}_{role}_{u['user_id']}")
        kb.button(text="â›” Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ", callback_data=f"assign_{deal_id}_{role}_none")
        kb.adjust(1)

        await callback.message.answer(f"ğŸ‘¤ ĞšĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ñ‹ Ğ½Ğ° Ñ€Ğ¾Ğ»ÑŒ `{role}` Ğ² *{deal['name']}*:", reply_markup=kb.as_markup(), parse_mode="Markdown")
        await callback.answer()

    except Exception as e:
        logger.error("[13.4] select_user_for_role: %s", e, exc_info=True)
        await callback.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğµ ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ğ².", show_alert=True)


@router.callback_query(lambda c: c.data.startswith("assign_"))
async def assign_user_to_role(callback: types.CallbackQuery) -> None:
    """ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ° Ñ€Ğ¾Ğ»ÑŒ Ğ¸Ğ»Ğ¸ ÑĞ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ."""
    try:
        _, deal_id, role, user_id = callback.data.split("_", 3)
        deal_id = str(deal_id)
        user_id = None if user_id == "none" else int(user_id)

        if deal_id not in bot_data.distribution_cache:
            bot_data.distribution_cache[deal_id] = {}

        if user_id:
            info = get_user_info(user_id)
            name = f"{info['first_name']} {info['last_name_initial']}" if info else "??"
            suffix = {
                "lead": ".1", "assistant": ".ĞŸĞ¾Ğ¼", "admin": ".ĞĞ´", "intern": ".Ğ¡Ñ‚Ğ°Ğ¶"
            }.get(role.split("1")[0], "")
            tag = f"{name}{suffix}"
        else:
            tag = ""

        bot_data.distribution_cache[deal_id][role] = tag
        await callback.answer("âœ… ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾.")
        await edit_compact_roles(callback)  # Ğ¿ĞµÑ€ĞµÑ€Ğ¸ÑĞ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ

    except Exception as e:
        logger.error("[13.4] assign_user_to_role: %s", e, exc_info=True)
        await callback.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¸.", show_alert=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# version: 1.0 (27.05.2025)
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 1.0: Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ° Ğ¿Ğ¾ Ñ€Ğ¾Ğ»ÑĞ¼ Ñ‡ĞµÑ€ĞµĞ· Ğ¸Ğ½Ğ»Ğ°Ğ¹Ğ½-ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ±ĞµĞ· Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ñ… Ğ¼ĞµĞ½Ñ


# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                   [15.0] ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Google Sheets                         â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ² Google Sheets.
# version: 1.1

async def create_distribution_table(spreadsheet_id: str, deals: List[Dict], distribution: Dict) -> None:
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ² Google Sheets.

    Args:
        spreadsheet_id: ID Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Google Sheets.
        deals: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ´ĞµĞ»Ğ¾Ğº.
        distribution: Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ.
    """
    try:
        creds = Credentials.from_service_account_file(GOOGLE_CREDENTIALS_FILE, scopes=GOOGLE_SHEETS_SCOPES)
        client = gspread.authorize(creds)
        spreadsheet = client.open_by_key(spreadsheet_id)
        sheet = spreadsheet.worksheet(DISTRIBUTION_SPREADSHEET_NAME)

        headers = ["ID ÑĞ´ĞµĞ»ĞºĞ¸", "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ", "Ğ”Ğ°Ñ‚Ğ° Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ", "ĞšĞ²ĞµÑÑ‚", "Ğ’ĞµĞ´ÑƒÑ‰Ğ¸Ğ¹ 1", "Ğ’ĞµĞ´ÑƒÑ‰Ğ¸Ğ¹ 2", "ĞŸĞ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº 1", "ĞŸĞ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº 2", "ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€"]
        data = [headers]

        for deal in deals:
            deal_id = str(deal["id"])
            dist = distribution.get(deal_id, {})
            row = [
                deal["id"],
                deal["name"],
                deal["event_datetime_str"],
                deal["game_name"],
                dist.get("lead1", ""),
                dist.get("lead2", ""),
                dist.get("assistant1", ""),
                dist.get("assistant2", ""),
                dist.get("admin", "")
            ]
            data.append(row)

        sheet.clear()
        sheet.update("A1", data)
        logger.info("[15.0] create_distribution_table: Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°, ÑÑ‚Ñ€Ğ¾Ğº: %d", len(data))
    except Exception as e:
        logger.error("[15.0] create_distribution_table: ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹: %s", e, exc_info=True)

# version: 1.1
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 1.0: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Google Sheets.
# - 1.1 (11.05.2025): Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸.

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                         [16.0] ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸Ğ³Ñ€                            â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞšĞ½Ğ¾Ğ¿ĞºĞ°-Ğ¸Ğ³Ñ€Ğ°: ğŸ‰ <ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ> <HH:MM> <ĞŸĞ°ĞºĞµÑ‚>  (Ğ¿Ğ°ĞºĞµÑ‚ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½)
# version: 2.3 (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ´ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)

async def show_games(
    message: types.Message,
    user_id: int,
    status_ids: List[str],
    title: str,
    only_unassigned: bool | None = None
) -> None:
    try:
        spreadsheet_id = bot_data.config.get("svetofor_spread_id")
        if not spreadsheet_id:
            await message.answer("âš ï¸ ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ ID Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Â«Ğ¡Ğ²ĞµÑ‚Ğ¾Ñ„Ğ¾Ñ€Â».")
            logger.error("[16.0] show_games: svetofor_spread_id Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚")
            return

        deals = await get_amocrm_deals(spreadsheet_id)
        if not deals:
            await message.answer(f"{title}\nğŸ˜” Ğ˜Ğ³Ñ€Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.")
            logger.info("[16.0] show_games: Ğ½ĞµÑ‚ ÑĞ´ĞµĞ»Ğ¾Ğº")
            return

        if only_unassigned is None:
            only_unassigned = (status_ids == NEW_GAMES_STATUS_IDS)

        now = datetime.now(tz=MSK_TZ)
        filtered = [
            d for d in deals
            if d["status_id"] in status_ids
               and d["event_datetime"] >= now
               and (not only_unassigned or not d["team_leads"])
        ]
        if not filtered:
            await message.answer(f"{title}\nğŸ˜” ĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… Ğ¸Ğ³Ñ€ Ğ½ĞµÑ‚.")
            logger.info("[16.0] show_games: Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾")
            return

        filtered.sort(key=lambda d: d["event_datetime"])
        filtered = filtered[:20]
        bot_data.games_by_user[user_id] = filtered

        kb = InlineKeyboardBuilder()
        for deal in filtered:
            time_part = deal.get("event_time", "")
            # ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ²Ğ·ÑÑ‚ÑŒ Ğ¿Ğ°ĞºĞµÑ‚ ÑƒÑĞ»ÑƒĞ³, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼
            pkg = (deal.get("package") or deal.get("extra_services") or "").strip()
            pkg_part = f" {pkg}" if pkg and pkg != "ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾" else ""

            btn_text = f"ğŸ‰ {deal['name']} {time_part}{pkg_part}"
            kb.button(text=btn_text, callback_data=f"game_details_{deal['id']}")

        kb.adjust(1)
        await message.answer(f"{title}\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ñƒ:", reply_markup=kb.as_markup())
        logger.info("[16.0] show_games: Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ %d Ğ¸Ğ³Ñ€ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ %d", len(filtered), user_id)

    except Exception as e:
        logger.error("[16.0] show_games: Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ»Ñ %d: %s", user_id, e, exc_info=True)
        await message.answer("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¸Ğ³Ñ€.")





# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                      [17.0] ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°                              â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹.
# version: 1.1

async def has_access(user_id: int, access_type: str) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, Ğ¸Ğ¼ĞµĞµÑ‚ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸.

    Args:
        user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
        access_type: Ğ¢Ğ¸Ğ¿ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° (games, poll, distribution).

    Returns:
        bool: True, ĞµÑĞ»Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ ĞµÑÑ‚ÑŒ.
    """
    try:
        user_info = get_user_info(user_id)
        if not user_info:
            logger.warning("[17.0] has_access: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ %d Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", user_id)
            return False

        role = user_info.get("role", "")
        has_access = role in ACCESS.get(access_type, [])
        logger.debug("[17.0] has_access: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ %d (%s) Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ğ» %s, Ğ´Ğ¾ÑÑ‚ÑƒĞ¿: %s", user_id, role, access_type, has_access)
        return has_access
    except Exception as e:
        logger.error("[17.0] has_access: ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ %d, Ñ‚Ğ¸Ğ¿ %s: %s", user_id, access_type, e, exc_info=True)
        return False

async def is_bot_admin(chat_id: int) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ±Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ñ‡Ğ°Ñ‚Ğ°.

    Args:
        chat_id: ID Ñ‡Ğ°Ñ‚Ğ°.

    Returns:
        bool: True, ĞµÑĞ»Ğ¸ Ğ±Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½.
    """
    try:
        chat_member = await bot.get_chat_member(chat_id, bot.id)
        is_admin = chat_member.status in ["administrator", "creator"]
        logger.debug("[17.0] is_bot_admin: Ğ‘Ğ¾Ñ‚ Ğ² Ñ‡Ğ°Ñ‚Ğµ %d, ÑÑ‚Ğ°Ñ‚ÑƒÑ: %s, Ğ°Ğ´Ğ¼Ğ¸Ğ½: %s", chat_id, chat_member.status, is_admin)
        return is_admin
    except TelegramAPIError as e:
        logger.error("[17.0] is_bot_admin: ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ² Ñ‡Ğ°Ñ‚Ğµ %d: %s", chat_id, e, exc_info=True)
        return False

# version: 1.1
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 1.0: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.
# - 1.1 (11.05.2025): Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸.
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                           â•‘
# â•‘                      [18.0] Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°                            â•‘
# â•‘                                                                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ², admin_chat_id, Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ
#           LEADER_ID Ğ² Ğ‘Ğ”, Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ°ÑÑ‚Ğ¾Ğ¼-Ğ¿Ğ¾Ğ»ĞµĞ¹, Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°.
# version: 1.4  (17.05.2025)  â† Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ AMOCRM_FIELDS

async def on_startup() -> None:
    """Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ±Ğ¾Ñ‚Ğ°."""
    try:
        # Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
        bot_data.config = await load_json(CONFIG_FILE)
        logger.info("[18.0] on_startup: ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ° Ğ¸Ğ· %s", CONFIG_FILE)

        # Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
        bot_data.tokens = await load_json(TOKENS_FILE)
        logger.info("[18.0] on_startup: Ğ¢Ğ¾ĞºĞµĞ½Ñ‹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ Ğ¸Ğ· %s", TOKENS_FILE)

        # Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ñ… ĞºĞ°ÑÑ‚Ğ¾Ğ¼-Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ¸Ğ· AMOCRM_FIELDS
        logger.info("[18.0] Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ ĞºĞ°ÑÑ‚Ğ¾Ğ¼-Ğ¿Ğ¾Ğ»Ñ AmoCRM:")
        for name, fid in AMOCRM_FIELDS.items():
            logger.info("    %s â†’ %s", name, fid)

        # Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ admin_chat_id
        if os.path.exists(CHAT_ID_FILE):
            with open(CHAT_ID_FILE, "r", encoding="utf-8") as f:
                bot_data.admin_chat_id = json.load(f).get("admin_chat_id")
            logger.info("[18.0] on_startup: admin_chat_id=%s", bot_data.admin_chat_id)
        else:
            logger.warning("[18.0] on_startup: Ñ„Ğ°Ğ¹Ğ» %s Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", CHAT_ID_FILE)

        # â”€â”€ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ LEADER_ID Ğ² checklists.db â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        import sqlite3
        db_path = os.path.join(BASE_DIR, "checklists.db")
        conn = sqlite3.connect(db_path)
        cur = conn.cursor()
        cur.execute(
            "CREATE TABLE IF NOT EXISTS users ("
            "user_id INTEGER PRIMARY KEY, first_name TEXT, last_name TEXT, role TEXT, scenario_access TEXT)"
        )
        cur.execute(
            "INSERT OR IGNORE INTO users(user_id, first_name, last_name, role) "
            "VALUES (?, '', '', 'Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒ')",
            (LEADER_ID,)
        )
        conn.commit()
        conn.close()
        logger.info("[18.0] on_startup: LEADER_ID %d Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ users", LEADER_ID)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        # Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ¼ĞµĞ½Ğ¸-Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ° pipeline Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²
        await generate_name_mapping()
        logger.info("[18.0] on_startup: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°")

    except Exception as e:
        logger.error("[18.0] on_startup: ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: %s", e, exc_info=True)
        raise

async def main() -> None:
    """Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ."""
    try:
        global bot, scheduler
        bot = Bot(token=API_TOKEN, default=DefaultBotProperties(parse_mode="Markdown"))
        dp = Dispatcher()
        scheduler = AsyncIOScheduler(timezone=MSK_TZ)

        dp.include_router(router)
        dp.startup.register(on_startup)
        scheduler.start()

        logger.info("[18.0] main: Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½, Ğ²ĞµÑ€ÑĞ¸Ñ %s", VERSION)
        await dp.start_polling(bot)
    except Exception as e:
        logger.critical("[18.0] main: ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: %s", e, exc_info=True)
        raise

if __name__ == "__main__":
    asyncio.run(main())

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:
# - 1.0 (??.05.2025): Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
# - 1.1 (11.05.2025): Ğ»Ğ¾Ğ³Ğ¸ Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° chat_id
# - 1.2 (12.05.2025): Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸Ğº Ñ MSK_TZ
# - 1.3 (13.05.2025): Ğ²ÑÑ‚Ğ°Ğ²ĞºĞ° LEADER_ID Ğ² Ğ‘Ğ” users
# - 1.4 (17.05.2025): Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ AMOCRM_FIELDS Ğ¿ĞµÑ€ĞµĞ´ ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ¼


# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆ                                                                         â–ˆ
# â–ˆ                         ĞšĞ¾Ğ½ĞµÑ† MasterBot 12.92                            â–ˆ
# â–ˆ                                                                         â–ˆ
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
