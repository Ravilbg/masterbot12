
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà                                                                         ‚ñà
# ‚ñà                           MasterBot 12.92                               ‚ñà
# ‚ñà                                                                         ‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# –û–ø–∏—Å–∞–Ω–∏–µ: Telegram-–±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –≤–µ–¥—É—â–∏—Ö –Ω–∞ –∫–≤–µ—Å—Ç—ã.
# –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
# - –ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫ –∏–∑ AmoCRM —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∏ –¥–∞—Ç–∞–º.
# - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∏–≥—Ä.
# - –°–æ–∑–¥–∞–Ω–∏–µ Telegram-–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–µ–¥—É—â–∏—Ö.
# - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤ –ø–æ –æ–ø—Ä–æ—Å–∞–º –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é.
# - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ AmoCRM –∏ Google Sheets —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
# –í–µ—Ä—Å–∏—è: 12.92
# –î–∞—Ç–∞: 13.05.2025

import asyncio
from contextlib import asynccontextmanager
import json
import logging
import os
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any, Union
import pytz
from aiogram import Bot, Dispatcher, Router, types
from aiogram.exceptions import TelegramAPIError, TelegramBadRequest
from aiogram.filters import Command, CommandStart
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.client.bot import DefaultBotProperties
from apscheduler.schedulers.asyncio import AsyncIOScheduler
import gspread
from google.oauth2.service_account import Credentials
import aiohttp
from logging.handlers import RotatingFileHandler


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –§–æ—Ä–≤–∞—Ä–¥-–¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è, —á—Ç–æ–±—ã Pylance –≤–∏–¥–µ–ª get_distribution_keyboard
def get_distribution_keyboard() -> InlineKeyboardMarkup:
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è IDE; —Ä–µ–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∏–∂–µ."""
    pass
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                       [1.0] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è                         ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å –∏ —Ñ–∞–π–ª —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π.
# version: 1.2

LOG_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), "logs")
os.makedirs(LOG_DIR, exist_ok=True)

logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s [%(levelname)s] [%(name)s] [%(filename)s:%(lineno)d] %(message)s",
    handlers=[
        RotatingFileHandler(
            os.path.join(LOG_DIR, "masterbot.log"),
            maxBytes=10 * 1024 * 1024,  # 10 MB
            backupCount=5,
            encoding="utf-8"
        ),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# version: 1.2
# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# - 1.0: –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
# - 1.1 (11.05.2025): –î–æ–±–∞–≤–ª–µ–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ª–æ–≥–æ–≤.
# - 1.2 (13.05.2025): –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞–ø–∫–∞ logs, —É–ª—É—á—à–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤.

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                       [2.0] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã                      ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–æ—Ç–∞, –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º, —Ç–æ–∫–µ–Ω—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
# version: 1.13

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–æ—Ç–∞
VERSION = "MasterBot 12.92"
CURRENT_YEAR = datetime.now().year
SPREADSHEET_NAME = f"–†–∞–±–æ—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã {CURRENT_YEAR}"
GOOGLE_API_RATE_LIMIT_SECONDS = 180
DATE_FILTER_THRESHOLD = timedelta(days=30)
POLL_DURATION = timedelta(hours=24)
CACHE_LIFETIME = timedelta(minutes=5)

# –¢–æ–∫–µ–Ω—ã –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
API_TOKEN = "7637424219:AAHXYNXHrRNZ1XwNbLx7ieBTZtafe6pmkYo"
LEADER_ID = os.getenv("MASTERBOT_LEADER_ID", "1018880781")

if not API_TOKEN or not isinstance(API_TOKEN, str):
    logger.critical("[2.0] API_TOKEN –Ω–µ –∑–∞–¥–∞–Ω –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π")
    raise SystemExit(1)
logger.info("[2.0] API_TOKEN —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω")

try:
    LEADER_ID = int(LEADER_ID)
except (ValueError, TypeError):
    logger.error("[2.0] MASTERBOT_LEADER_ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º, –ø–æ–ª—É—á–µ–Ω–æ: %s", LEADER_ID)
    raise SystemExit(1)

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
LOG_FILE = os.path.join(BASE_DIR, "logs", "masterbot.log")
CHAT_ID_FILE = os.path.join(BASE_DIR, "chat_id.json")
MASTERBOT_DB = os.path.join(BASE_DIR, "masterbot.db")
CONFIG_FILE = os.path.join(BASE_DIR, "config.json")
TOKENS_FILE = os.path.join(BASE_DIR, "tokens.json")

# –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Google Sheets
GOOGLE_CREDENTIALS_FILE = os.getenv("GOOGLE_CREDENTIALS_PATH")
if not GOOGLE_CREDENTIALS_FILE:
    possible_files = [
        "svetofor-credentials.json",
        "service-account-key.json",
        "credentials.json"
    ]
    for fname in possible_files:
        candidate = os.path.join(BASE_DIR, fname)
        if os.path.exists(candidate):
            GOOGLE_CREDENTIALS_FILE = candidate
            logger.info("[2.0] –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Google Sheets: %s", GOOGLE_CREDENTIALS_FILE)
            break

if GOOGLE_CREDENTIALS_FILE and os.path.exists(GOOGLE_CREDENTIALS_FILE):
    try:
        with open(GOOGLE_CREDENTIALS_FILE, 'r', encoding='utf-8') as f:
            creds_data = json.load(f)
            client_email = creds_data.get("client_email", "–Ω–µ —É–∫–∞–∑–∞–Ω")
            logger.info("[2.0] –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Google Sheets –∑–∞–≥—Ä—É–∂–µ–Ω—ã: client_email=%s", client_email)
    except (json.JSONDecodeError, KeyError) as e:
        logger.error("[2.0] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Google Sheets: %s", e, exc_info=True)
        GOOGLE_CREDENTIALS_FILE = None
else:
    GOOGLE_CREDENTIALS_FILE = os.path.join(BASE_DIR, "svetofor-credentials.json")
    logger.warning(
        "[2.0] –§–∞–π–ª —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Google Sheets –Ω–µ –Ω–∞–π–¥–µ–Ω: %s. –§—É–Ω–∫—Ü–∏–∏ Google Sheets –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.",
        GOOGLE_CREDENTIALS_FILE
    )

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
SVETOFOR_SHEET = "–°–≤–µ—Ç–æ—Ñ–æ—Ä"
DISTRIBUTION_SPREADSHEET_NAME = "–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è"
ALLOWED_STATUSES = ["–ë—Ä–æ–Ω—å", "–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–¥–µ–ª–∫–∏", "–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—è–≤–∫–∞"]
ALLOWED_STATUS_IDS = ["18913933", "18960415", "18913930"]
NEW_GAMES_STATUS_IDS = ["18913930", "18913933"]
SUCCESSFUL_STATUS_ID = "18960415"
DATE_FILTER_DAYS = 30
PREPAYMENT_FIELD_ID = None
PACKAGE_FIELD_ID = "71673"
MSK_TZ = pytz.timezone("Europe/Moscow")
GOOGLE_SHEETS_SCOPES = [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive"
]

# –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
ACCESS = {
    "games": ["—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å", "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", "–≤–µ–¥—É—â–∏–π", "–≤–µ–¥—É—â–∏–π –Ω–æ–≤–∏—á–æ–∫"],
    "poll": ["—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å", "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"],
    "distribution": ["—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å", "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"],
}

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
WEEKDAYS = {
    "Monday": "–ü–Ω", "Tuesday": "–í—Ç", "Wednesday": "–°—Ä", "Thursday": "–ß—Ç",
    "Friday": "–ü—Ç", "Saturday": "–°–±", "Sunday": "–í—Å–∫",
}

# –†–æ–ª–∏ –¥–ª—è –∏–≥—Ä
GAME_ROLE_MAPPING = {
    "–ü–µ—Ç–ª—è –≤—Ä–µ–º–µ–Ω–∏": {"main_leaders": 1, "assistants": 1},
    "–•—Ä–∞–Ω–∏—Ç–µ–ª–∏ –≤–æ–ª—à–µ–±—Å—Ç–≤–∞": {"main_leaders": 1, "assistants": 1},
    "–í—Ä–µ–º—è –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π": {"main_leaders": 1, "assistants": 2},
    "–ö–ª–∞–Ω—ã –ù—å—é-–ô–æ—Ä–∫–∞": {"main_leaders": 1, "assistants": 3},
    "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä –∏–≥—Ä": {"main_leaders": 1, "assistants": 1},
    "–ë–µ—Ä–º—É–¥—Å–∫–∏–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫": {"main_leaders": 1, "assistants": 3},
    "–°—Ç–∞—Ä—ã–π –¥–æ–º": {"main_leaders": 1, "assistants": 1},
    "–¶–≤–µ—Ç–æ—á–Ω–∞—è –±–∞—à–Ω—è": {"main_leaders": 2, "assistants": 0}
}


AMOCRM_FIELDS = {
    "event_date":     "87751",    # –î–∞—Ç–∞
    "event_time":     "88565",    # –≤—Ä–µ–º—è
    "game_name":      "87791",    # –ö–≤–µ—Å—Ç
    "age":            "899511",   # –í–æ–∑—Ä–∞—Å—Ç –∏–≥—Ä–æ–∫–æ–≤
    "extra_services": "452955",   # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–ü–∏–Ω—å—è—Ç–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫)
    "comment":        "87811",    # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    "prepayment":     "100407",   # –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞
    "team_leads":     "88567",    # –í–µ–¥—É—â–∏–µ
    "photographer":   "87813",    # –§–æ—Ç–æ–≥—Ä–∞—Ñ
    "players":        "71635",    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
    "package":        "71673",    # –ü–∞–∫–µ—Ç —É—Å–ª—É–≥
}

# version: 1.13
# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# - 1.0: –ò—Å—Ö–æ–¥–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è.
# - 1.2: –£–ª—É—á—à–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞.
# - 1.3: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.
# - 1.4: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞.
# - 1.5: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è NameError.
# - 1.6: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
# - 1.7: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ GOOGLE_CREDENTIALS_PATH.
# - 1.8: –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–∏–ø–∏—á–Ω—ã–º –∏–º–µ–Ω–∞–º.
# - 1.9: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ client_email –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
# - 1.10: –ò–∑–º–µ–Ω—ë–Ω –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏–º—è svetofor-credentials.json.
# - 1.11: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ –≤ —Ü–∏–∫–ª–µ for.
# - 1.12 (12.05.2025): API_TOKEN –ø—Ä–æ–ø–∏—Å–∞–Ω –≤ –∫–æ–¥–µ, –¥–æ–±–∞–≤–ª–µ–Ω—ã MSK_TZ, GAME_ROLE_MAPPING, AMOCRM_FIELDS, —É–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.
# - 1.13 (13.05.2025): –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –ª–æ–≥–æ–≤, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞–ø–∫–∞ logs.

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                       [3.0] –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã                            ‚ïë
# ‚ïë  version: 1.4 (08.06.2025) ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω detail_blocks                       ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

from typing import Dict, List, Optional, Tuple
from datetime import datetime
from aiogram import types
from aiogram.types import InlineKeyboardMarkup


class BotData:
    """–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –∂–∏—Ç—å –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞."""
    def __init__(self) -> None:
        # ‚îÄ‚îÄ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è / —Ç–æ–∫–µ–Ω—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.config: Dict = {}
        self.tokens: Dict = {}

        # ‚îÄ‚îÄ Chat / Spreadsheet IDs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.admin_chat_id: Optional[int] = None
        self.svetofor_spreadsheet_id: Optional[str] = None

        # ‚îÄ‚îÄ –û–ø—Ä–æ—Å—ã –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.current_poll_deals: List[Dict] = []
        self.responses: Dict = {}                        # poll_id ‚Üí –æ—Ç–≤–µ—Ç—ã
        self.distribution_cache: Dict = {}               # deal_id ‚Üí {role: tag}
        self.distribution_keyboard: Optional[InlineKeyboardMarkup] = None

        # ‚îÄ‚îÄ –°–ª—É–∂–µ–±–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.personal_report_message_id: Optional[int] = None
        self.current_poll_leader: Optional[int] = None
        self.coordination_cycle_active: bool = False

        # ‚îÄ‚îÄ –ü–µ—Ä–∏–æ–¥—ã –æ—Ç—á—ë—Ç–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.current_event_period: Optional[List[datetime]] = None
        self.last_event_period: Optional[List[datetime]] = None

        # ‚îÄ‚îÄ –ö–µ—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.pipeline_mapping: Dict = {}
        self.deals_cache: Dict = {}
        self.messages_to_delete: Dict[int, List[int]] = {}
        self.last_user_messages: Dict[int, List[types.Message]] = {}
        self.detail_blocks: Dict[Tuple[int, int], List[types.Message]] = {}  # (uid, deal) ‚Üí msgs

        # ‚îÄ‚îÄ UI-–ø–æ–¥–¥–µ—Ä–∂–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.games_by_user: Dict[int, List[Dict]] = {}


bot_data = BotData()

# version-history:
# 1.0 ‚Äî –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
# 1.1 ‚Äî deals_cache, messages_to_delete
# 1.2 ‚Äî games_by_user
# 1.3 ‚Äî last_user_messages
# 1.4 ‚Äî detail_blocks



# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                           [4.0] –£—Ç–∏–ª–∏—Ç—ã                                   ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏.
# version: 1.1

def parse_players_count(players: Any) -> int:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ —Å—Ç—Ä–æ–∫–∏.

    Args:
        players: –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è players (—Å—Ç—Ä–æ–∫–∞, —á–∏—Å–ª–æ –∏–ª–∏ None).

    Returns:
        int: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –∏–ª–∏ 0 –ø—Ä–∏ –æ—à–∏–±–∫–µ.
    """
    try:
        if not players:
            return 0
        players_str = str(players).strip()
        if "-" in players_str:
            return int(players_str.split("-")[-1].strip())
        return int(players_str)
    except (ValueError, TypeError) as e:
        logger.warning("[4.0] parse_players_count: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ players=%s: %s", players, e)
        return 0

async def load_json(file_path: str) -> Dict:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç JSON-—Ñ–∞–π–ª.

    Args:
        file_path: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É.

    Returns:
        Dict: –î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞.

    Raises:
        FileNotFoundError: –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.
        json.JSONDecodeError: –ï—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON.
    """
    if not os.path.exists(file_path):
        logger.error("[4.0] load_json: –§–∞–π–ª %s –Ω–µ –Ω–∞–π–¥–µ–Ω", file_path)
        raise FileNotFoundError(f"–§–∞–π–ª {file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω")
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            data = json.load(f)
            logger.debug("[4.0] load_json: –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª %s", file_path)
            return data
    except json.JSONDecodeError as e:
        logger.error("[4.0] load_json: –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON –≤ %s: %s", file_path, e)
        raise

async def save_json(file_path: str, data: Dict) -> bool:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON-—Ñ–∞–π–ª.

    Args:
        file_path: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É.
        data: –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.

    Returns:
        bool: –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏.
    """
    try:
        with open(file_path, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2, ensure_ascii=False)
        logger.debug("[4.0] save_json: –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ %s", file_path)
        return True
    except Exception as e:
        logger.error("[4.0] save_json: –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è %s: %s", file_path, e, exc_info=True)
        return False

# version: 1.1
# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# - 1.0: –ë–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã.
# - 1.1 (11.05.2025): –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–∞–∑–¥–µ–ª–∞.

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                   [5.0] –†–∞–±–æ—Ç–∞ —Å Google Sheets                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –ß–∏—Ç–∞–µ—Ç –ª–∏—Å—Ç ¬´–°–≤–µ—Ç–æ—Ñ–æ—Ä¬ª –∏–∑ Google Sheets, –∫–µ—à–∏—Ä—É—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏
#          –¥–∞–Ω–Ω—ã–µ, –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç–∞—Ç—É—Å –ø–æ —Ü–≤–µ—Ç—É —è—á–µ–π–∫–∏.
# version: 1.8 ‚Äî –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ includeGridData, case-insensitive –∑–∞–≥–æ–ª–æ–≤–∫–∏

from typing import Optional
import gspread
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build

# –º–æ–¥—É–ª—å-—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫–µ—à
_svetofor_cache: dict = {
    "sheet": None,           # gspread.Worksheet
    "service": None,         # Google Sheets API client
    "spreadsheet_id": None,
    "rows": None,            # list[rowData]
    "headers": None,         # list[str] –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
}

def _init_svetofor() -> None:
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç sheet, service –∏ spreadsheet_id –æ–¥–∏–Ω —Ä–∞–∑."""
    if _svetofor_cache["sheet"] is None:
        sid = bot_data.config.get("svetofor_spread_id")
        if not sid:
            raise RuntimeError("[5.0] _init_svetofor: 'svetofor_spread_id' –Ω–µ –∑–∞–¥–∞–Ω")
        creds = Credentials.from_service_account_file(
            GOOGLE_CREDENTIALS_FILE, scopes=GOOGLE_SHEETS_SCOPES
        )
        client = gspread.authorize(creds)
        sheet = client.open_by_key(sid).sheet1
        service = build("sheets", "v4", credentials=creds)

        _svetofor_cache.update({
            "sheet": sheet,
            "service": service,
            "spreadsheet_id": sid,
        })

def _load_svetofor_data() -> None:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç meta —Å includeGridData –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ + –∑–∞–≥–æ–ª–æ–≤–∫–∏.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –µ–¥–∏–Ω–æ–∂–¥—ã –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á—ë—Ç–∞.
    """
    if _svetofor_cache["rows"] is None:
        svc = _svetofor_cache["service"]
        sid = _svetofor_cache["spreadsheet_id"]
        meta = svc.spreadsheets().get(
            spreadsheetId=sid, includeGridData=True
        ).execute()

        # –Ω–∞–π–¥—ë–º –Ω—É–∂–Ω—ã–π –ª–∏—Å—Ç –ø–æ sheetId
        props = _svetofor_cache["sheet"].id
        sheet_meta = next(
            s for s in meta["sheets"]
            if s["properties"]["sheetId"] == props
        )
        rows = sheet_meta["data"][0].get("rowData", [])
        # –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏
        header_cells = rows[0].get("values", [])
        headers = [
            c.get("formattedValue", "").strip()
            for c in header_cells
        ]

        _svetofor_cache["rows"] = rows
        _svetofor_cache["headers"] = headers

async def get_user_row_from_svetofor(user_id: int) -> Optional[int]:
    """
    –ò—â–µ—Ç user_id (–≤ –∫–æ–ª–æÃÅ–Ω–∫–µ B) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ (1-based),
    –∏–ª–∏ None, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.
    """
    try:
        _init_svetofor()
        _load_svetofor_data()
        rows = _svetofor_cache["rows"]
        target = str(user_id)
        for idx, row in enumerate(rows, start=1):
            vals = row.get("values", [])
            # —Å—Ç–æ–ª–±–µ—Ü B ‚Üí –∏–Ω–¥–µ–∫—Å 1
            if len(vals) > 1 and vals[1].get("formattedValue", "").strip() == target:
                return idx
    except Exception as e:
        logger.error("[5.0] get_user_row_from_svetofor: %s", e, exc_info=True)
    return None

async def get_game_column_from_svetofor(game_name: str) -> Optional[int]:
    """
    –ò—â–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ game_name –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ (–±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞),
    –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–±—Ü–∞ (1-based) –∏–ª–∏ None.
    """
    try:
        _init_svetofor()
        _load_svetofor_data()
        norm = game_name.strip().lower()
        for idx, title in enumerate(_svetofor_cache["headers"], start=1):
            if title.lower() == norm:
                return idx
        logger.warning("[5.0] get_game_column: –∑–∞–≥–æ–ª–æ–≤–æ–∫ %r –Ω–µ –Ω–∞–π–¥–µ–Ω", game_name)
    except Exception as e:
        logger.error("[5.0] get_game_column_from_svetofor: %s", e, exc_info=True)
    return None

def _rgb_to_status(r: float, g: float, b: float) -> str:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç backgroundColor –∏–∑ 0.0‚Äì1.0 –≤:
      green  if (g>0.5 and r<0.5)
      yellow if (r>0.5 and g>0.5)
      red    if (r>0.5 and g<0.5)
      ""     –∏–Ω–∞—á–µ
    """
    if g > 0.5 and r < 0.5:
        return "green"
    if r > 0.5 and g > 0.5:
        return "yellow"
    if r > 0.5 and g < 0.5:
        return "red"
    return ""

async def get_user_status_from_svetofor(user_id: int, game_name: str) -> str:
    """
    –ü–æ user_id –∏ game_name –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–≤–µ—Ç —è—á–µ–π–∫–∏:
    'green' | 'yellow' | 'red' | ''.
    """
    try:
        row = await get_user_row_from_svetofor(user_id)
        col = await get_game_column_from_svetofor(game_name)
        if not row or not col:
            return ""
        # –±–µ—Ä—ë–º –∏–∑ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö rows
        cell = _svetofor_cache["rows"][row - 1] \
                    .get("values", [])[col - 1]
        bg = cell.get("effectiveFormat", {}) \
                 .get("backgroundColor", {})
        return _rgb_to_status(
            bg.get("red",   0.0),
            bg.get("green", 0.0),
            bg.get("blue",  0.0)
        )
    except Exception as e:
        logger.error("[5.0] get_user_status_from_svetofor: %s", e, exc_info=True)
        return ""


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                       [6.0] –†–∞–±–æ—Ç–∞ —Å AmoCRM                               ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ AmoCRM —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
# version: 2.3

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ensure_valid_token ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def ensure_valid_token() -> bool:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ access‚Äëtoken –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (–∏–ª–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω)."""
    try:
        if not bot_data.tokens:
            bot_data.tokens = await load_json(TOKENS_FILE)
            if not bot_data.tokens:
                logger.error("[6.0] ensure_valid_token: —Ñ–∞–π–ª —Ç–æ–∫–µ–Ω–æ–≤ –ø—É—Å—Ç %s", TOKENS_FILE)
                return False

        expires_at = bot_data.tokens.get("expires_at", 0)
        if datetime.now().timestamp() >= expires_at - 300:
            logger.info("[6.0] ensure_valid_token: token –∏—Å—Ç–µ–∫–∞–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º ‚Ä¶")
            return await refresh_amocrm_token()

        logger.debug("[6.0] ensure_valid_token: token ok –¥–æ %s",
                     datetime.fromtimestamp(expires_at))
        return True
    except Exception as e:
        logger.exception("[6.0] ensure_valid_token: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ %s", e)
        return False


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ refresh_amocrm_token ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def refresh_amocrm_token() -> bool:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç refresh‚Äë—Ç–æ–∫–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∞ –¥–∏—Å–∫."""
    try:
        cfg = bot_data.config or {}
        required = ("client_id", "client_secret", "redirect_uri", "domain")
        if any(k not in cfg for k in required):
            logger.error("[6.0] refresh_amocrm_token: –Ω–µ–ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ AmoCRM %s", cfg)
            return False

        async with aiohttp.ClientSession() as s:
            payload = {
                "client_id":     cfg["client_id"],
                "client_secret": cfg["client_secret"],
                "grant_type":    "refresh_token",
                "refresh_token": bot_data.tokens.get("refresh_token", ""),
                "redirect_uri":  cfg["redirect_uri"],
            }
            async with s.post(f"https://{cfg['domain']}/oauth2/access_token",
                              json=payload) as r:
                if r.status != 200:
                    logger.error("[6.0] refresh_amocrm_token: HTTP %d ‚Äì %s",
                                 r.status, await r.text())
                    return False
                data = await r.json()
                data["expires_at"] = (
                    datetime.now() + timedelta(seconds=data.get("expires_in", 86400))
                ).timestamp()
                bot_data.tokens.update(data)
                await save_json(TOKENS_FILE, bot_data.tokens)
                logger.info("[6.0] refresh_amocrm_token: token –æ–±–Ω–æ–≤–ª—ë–Ω")
                return True
    except Exception as e:
        logger.exception("[6.0] refresh_amocrm_token: —Å–±–æ–π %s", e)
        return False


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ get_pipeline_stages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def get_pipeline_stages() -> Dict[str, str]:
    """ID‚Äë‚Üí‚Äë–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤—Å–µ—Ö –≤–æ—Ä–æ–Ω–æ–∫."""
    try:
        if not await ensure_valid_token():
            return {}

        async with aiohttp.ClientSession() as s:
            head = {"Authorization": f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"}
            async with s.get(f"https://{bot_data.config['domain']}/api/v4/leads/pipelines",
                             headers=head) as r:
                if r.status != 200:
                    logger.error("[6.0] get_pipeline_stages: HTTP %d", r.status)
                    return {}
                js = await r.json()
                stages = {
                    str(st["id"]): st["name"]
                    for pl in js["_embedded"]["pipelines"]
                    for st in pl["_embedded"]["statuses"]
                }
                logger.debug("[6.0] get_pipeline_stages: %d —Å—Ç–∞—Ç—É—Å–æ–≤", len(stages))
                return stages
    except Exception as e:
        logger.exception("[6.0] get_pipeline_stages: –æ—à–∏–±–∫–∞ %s", e)
        return {}


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ get_custom_fields ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def get_custom_fields() -> Dict[str, str]:
    """ID‚Äë‚Üí‚Äë–ù–∞–∑–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–µ–π —Å–¥–µ–ª–æ–∫."""
    try:
        if not await ensure_valid_token():
            return {}

        async with aiohttp.ClientSession() as s:
            head = {"Authorization": f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"}
            async with s.get(f"https://{bot_data.config['domain']}/api/v4/leads/custom_fields",
                             headers=head) as r:
                if r.status != 200:
                    logger.error("[6.0] get_custom_fields: HTTP %d", r.status)
                    return {}
                js = await r.json()
                fields = {str(f["id"]): f["name"] for f in js["_embedded"]["custom_fields"]}
                logger.debug("[6.0] get_custom_fields: %d –ø–æ–ª–µ–π", len(fields))
                return fields
    except Exception as e:
        logger.exception("[6.0] get_custom_fields: –æ—à–∏–±–∫–∞ %s", e)
        return {}


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ fetch_amocrm_deals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def fetch_amocrm_deals(spreadsheet_id: str) -> List[Dict]:
    """–•–æ–¥–∏—Ç –≤ AmoCRM, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏."""
    try:
        if not bot_data.config or not await ensure_valid_token():
            return []

        custom_fields, stages = await asyncio.gather(
            get_custom_fields(), get_pipeline_stages()
        )
        if not custom_fields or not stages:
            return []

        # üëâ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø–æ–ª—è ¬´–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞¬ª
        global PREPAYMENT_FIELD_ID
        PREPAYMENT_FIELD_ID = next(
            (fid for fid, name in custom_fields.items() if "–ø—Ä–µ–¥–æ–ø–ª–∞—Ç" in name.lower()),
            None
        )

        deals: List[Dict] = []
        page, limit = 1, 250
        updated_from = int((datetime.now() - timedelta(days=DATE_FILTER_DAYS)).timestamp())
        pipeline_id = bot_data.config.get("pipeline_id")  # –º–æ–∂–µ—Ç –±—ã—Ç—å None

        async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=20)) as s:
            head = {"Authorization": f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"}

            while True:
                params: Dict[str, Union[str, int]] = {
                    "with": "contacts,tags",
                    "limit": limit,
                    "page": page,
                    "filter[updated_at][from]": updated_from,
                }
                # –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º None ‚Üí –∏–Ω–∞—á–µ TypeError inside yarl
                if pipeline_id:
                    params["filter[pipeline_id]"] = pipeline_id

                # –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ (–∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–π 12.90)
                for i, sid in enumerate(ALLOWED_STATUS_IDS):
                    params[f"filter[statuses][{i}][pipeline_id][0][statuses][0]"] = sid

                async with s.get(f"https://{bot_data.config['domain']}/api/v4/leads",
                                 headers=head, params=params) as r:
                    logger.debug("[6.0] fetch_amocrm_deals: p.%d http=%d", page, r.status)

                    if r.status == 204:
                        break
                    if r.status == 401 and await refresh_amocrm_token():
                        head["Authorization"] = (
                            f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"
                        )
                        continue
                    if r.status != 200:
                        logger.error("[6.0] fetch_amocrm_deals: HTTP %d ‚Äì %s",
                                     r.status, await r.text())
                        return []

                    js = await r.json()
                    leads = js.get("_embedded", {}).get("leads", [])
                    if not leads:
                        break

                    for raw in leads:
                        if str(raw.get("status_id")) in ALLOWED_STATUS_IDS:
                            processed = await process_deal(raw, stages, custom_fields, spreadsheet_id)
                            if processed:
                                deals.append(processed)

                    page += 1
                    await asyncio.sleep(1)  # soft‚Äëlimit

        deals.sort(key=lambda d: d["event_datetime"])
        logger.info("[6.0] fetch_amocrm_deals: %d —Å–¥–µ–ª–æ–∫", len(deals))
        return deals

    except Exception as e:
        logger.exception("[6.0] fetch_amocrm_deals: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ %s", e)
        return []


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ get_amocrm_deals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def get_amocrm_deals(spreadsheet_id: str, refresh: bool = False) -> List[Dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–¥–µ–ª–∫–∏ –∏–∑ –∫—ç—à–∞ –ª–∏–±–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏."""
    try:
        cache_key = f"deals_{spreadsheet_id}"
        cache_entry = bot_data.deals_cache.get(cache_key)
        if cache_entry and not refresh:
            age = datetime.now() - cache_entry["timestamp"]
            if age < CACHE_LIFETIME:
                logger.debug("[6.0] deals‚Äëcache HIT | %s | age %.1fs", spreadsheet_id, age.total_seconds())
                return cache_entry["deals"]

        deals = await fetch_amocrm_deals(spreadsheet_id)
        bot_data.deals_cache[cache_key] = {"deals": deals, "timestamp": datetime.now()}
        logger.debug("[6.0] deals‚Äëcache –æ–±–Ω–æ–≤–ª—ë–Ω | %s | %d —Å–¥–µ–ª–æ–∫", spreadsheet_id, len(deals))
        return deals
    except Exception as e:
        logger.exception("[6.0] get_amocrm_deals: –æ—à–∏–±–∫–∞ %s", e)
        return []


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ update_amocrm_tags ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def update_amocrm_tags(deal_id: int, tags: List[str]) -> bool:
    """–ü–∞—Ç—á–∏—Ç —Ç–µ–≥–∏ —Å–¥–µ–ª–∫–∏.  True ‚Üí —É—Å–ø–µ—à–Ω–æ."""
    try:
        if not await ensure_valid_token():
            return False

        async with aiohttp.ClientSession() as s:
            head = {"Authorization": f"{bot_data.tokens['token_type']} {bot_data.tokens['access_token']}"}
            payload = {"_embedded": {"tags": [{"name": t} for t in tags]}}

            async with s.patch(f"https://{bot_data.config['domain']}/api/v4/leads/{deal_id}",
                               headers=head, json=payload) as r:
                if r.status == 429:
                    await asyncio.sleep(1)
                    async with s.patch(f"https://{bot_data.config['domain']}/api/v4/leads/{deal_id}",
                                       headers=head, json=payload) as r2:
                        r = r2  # –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç

                if r.status != 200:
                    logger.error("[6.0] update_amocrm_tags: HTTP %d ‚Äì %s", r.status, await r.text())
                    return False

                logger.info("[6.0] update_amocrm_tags: ok deal=%d %s", deal_id, tags)
                return True
    except Exception as e:
        logger.exception("[6.0] update_amocrm_tags: –æ—à–∏–±–∫–∞ %s", e)
        return False

# version: 2.3
# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# - 2.0 (12.05.2025): –ø–∞–≥–∏–Ω–∞—Ü–∏—è, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ª–æ–≥.
# - 2.1 (13.05.2025): –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ—à–∏–±–æ–∫.
# - 2.2 (14.05.2025): —Ñ–∏–∫—Å—ã JSON‚Äëdecode –∏ rate‚Äëlimit.
# - 2.3 (15.05.2025): –∏—Å–∫–ª—é—á—ë–Ω pipeline_id=None, —Å—Ç–∞—Ç—É—Å—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚Äî
#                    —É—Å—Ç—Ä–∞–Ω—ë–Ω TypeError ¬´Invalid variable type¬ª –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ.

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                   [7.0] –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö AmoCRM                           ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç ¬´—Å—ã—Ä—É—é¬ª —Å–¥–µ–ª–∫—É –∏–∑ AmoCRM –≤ –µ–¥–∏–Ω—ã–π dict –¥–ª—è –±–æ—Ç–∞.
#           ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—è ¬´–î–æ–ø. —É—Å–ª—É–≥–∏¬ª
#           ‚Ä¢ –ü–æ–Ω–∏–º–∞–µ—Ç Unix-—Ç–∞–π–º—Å—Ç–∞–º–ø (—Å–µ–∫/–º—Å) –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏
#           ‚Ä¢ –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ event_time (—Å—Ç—Ä–æ–∫–∞ ¬´HH:MM¬ª)
#           ‚Ä¢ –õ–æ–≥–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
# version: 2.8 (13.05.2025) ‚Äî —Å–æ–∫—Ä–∞—â–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

def _parse_event_datetime(raw_date: Any, raw_time: Any) -> Optional[datetime]:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –¥–∞—Ç—ã + –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ AmoCRM.
    """
    try:
        ts = float(raw_date)
        if ts > 1e12:
            ts /= 1000
        return MSK_TZ.localize(datetime.fromtimestamp(int(ts)))
    except (TypeError, ValueError):
        pass

    date_str = str(raw_date or "").strip()
    time_str = str(raw_time or "").strip()
    if time_str.lower() == "–Ω–µ —É–∫–∞–∑–∞–Ω–æ":
        time_str = ""
    candidate = f"{date_str} {time_str}".strip()

    for fmt in (
        "%Y-%m-%d %H:%M", "%d.%m.%Y %H:%M",
        "%d/%m/%Y %H:%M", "%Y.%m.%d %H:%M",
        "%Y-%m-%d",      "%d.%m.%Y",
        "%d/%m/%Y",      "%Y.%m.%d"
    ):
        try:
            dt = datetime.strptime(candidate, fmt)
            if " %H:%M" not in fmt:
                dt = dt.replace(hour=0, minute=0)
            return MSK_TZ.localize(dt)
        except ValueError:
            continue

    return None


async def process_deal(
    deal: Dict,
    stages: Dict[str, str],
    custom_fields: Dict[str, str],
    spreadsheet_id: str,
) -> Optional[Dict]:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç ¬´—Å—ã—Ä—É—é¬ª —Å–¥–µ–ª–∫—É AmoCRM –≤ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π dict.
    """
    deal_id = deal.get("id")
    if not deal_id:
        logger.warning("[7.0] process_deal: –Ω–µ—Ç id —Å–¥–µ–ª–∫–∏")
        return None

    logger.info("[7.0] process_deal START deal_id=%s", deal_id)

    try:
        # –°–æ–±–∏—Ä–∞–µ–º custom_fields_values
        cf_raw = deal.get("custom_fields_values") or []
        cf: Dict[str, List[Any]] = {
            str(f.get("field_id")): [v["value"] for v in f.get("values", []) if v.get("value") is not None]
            for f in cf_raw
        }

        # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
        raw_date = cf.get(AMOCRM_FIELDS["event_date"], [None])[0]
        raw_time = cf.get(AMOCRM_FIELDS["event_time"], [""])[0]
        event_dt = _parse_event_datetime(raw_date, raw_time)
        if not event_dt:
            logger.error("[7.0] process_deal: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É deal_id=%s", deal_id)
            return None
        event_time = (str(raw_time).strip()
                      if raw_time and str(raw_time).strip().lower() != "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"
                      else event_dt.strftime("%H:%M"))

        # –§–∏–Ω–∞–Ω—Å—ã
        def to_int(val, default=0):
            try:
                return int(float(str(val).replace(",", ".")))
            except (TypeError, ValueError):
                return default

        total_budget = deal.get("price", 0)
        prepayment   = to_int(cf.get(AMOCRM_FIELDS["prepayment"], [0])[0])
        to_calculate = total_budget - prepayment

        # –í–µ–¥—É—â–∏–µ
        leads_raw = cf.get(AMOCRM_FIELDS["team_leads"], [])
        team_leads = [
            {"id": lid, "name": get_lead_name(lid)}
            for lid in map(str, leads_raw) if lid.strip()
        ]

        # –î–æ–ø. —É—Å–ª—É–≥–∏
        pinata_list    = cf.get(AMOCRM_FIELDS["extra_services"], [])  # ¬´–ü–∏–Ω—å—è—Ç–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫¬ª
        other_services = cf.get("413875", [])  # ¬´–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ¬ª
        all_services   = pinata_list + other_services
        extra_services = ", ".join(map(str, all_services)) if all_services else ""

        # –ü–∞–∫–µ—Ç —É—Å–ª—É–≥
        package_list = cf.get(AMOCRM_FIELDS["package"], [""])
        package = str(package_list[0]) if package_list else ""

        # –ü—Ä–æ—á–∏–µ –ø–æ–ª—è
        game_name    = cf.get(AMOCRM_FIELDS["game_name"], [""])[0]
        players      = cf.get(AMOCRM_FIELDS["players"], [""])[0]
        age          = cf.get(AMOCRM_FIELDS["age"], [""])[0]
        comment      = cf.get(AMOCRM_FIELDS["comment"], [""])[0] or ""
        photographer = cf.get(AMOCRM_FIELDS["photographer"], [""])[0] or ""

        processed = {
            "id":                 deal_id,
            "name":               deal.get("name", f"–°–¥–µ–ª–∫–∞ {deal_id}"),
            "game_name":          game_name,
            "status_id":          str(deal.get("status_id", "")),
            "status":             stages.get(str(deal.get("status_id", "")), "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"),
            "event_datetime":     event_dt,
            "event_datetime_str": f"{event_dt.strftime('%d.%m.%Y')}, {event_time}",
            "event_time":         event_time,
            "players":            players,
            "players_count":      parse_players_count(players),
            "age":                age,
            "package":            package,
            "extra_services":     extra_services,
            "comment":            comment,
            "total_budget":       total_budget,
            "prepayment":         prepayment,
            "to_calculate":       to_calculate,
            "team_leads":         team_leads,
            "photographer":       photographer,
        }

        logger.info("[7.0] process_deal DONE deal_id=%s", deal_id)
        return processed

    except Exception as e:
        logger.exception("[7.0] process_deal: –æ—à–∏–±–∫–∞ deal_id=%s: %s", deal_id, e)
        return None


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                    [8.0] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ                          ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∏–∑ SQLite (checklists.db).
# version: 1.3

def get_user_info(user_id: int) -> Optional[Dict]:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ SQLite.

    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    Returns:
        Optional[Dict]: {
            first_name: str,
            last_name_initial: str,
            role: str,
            status: str,
            games_last_30_days: int
        } –∏–ª–∏ None, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.
    """
    try:
        import sqlite3

        db_path = os.path.join(BASE_DIR, "checklists.db")
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT first_name, last_name, role FROM users WHERE user_id = ?",
            (user_id,)
        )
        row = cursor.fetchone()
        conn.close()

        if not row:
            logger.warning("[8.0] get_user_info: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %d –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ %s", user_id, db_path)
            return None

        first_name, last_name, role = row
        last_initial = last_name[0] if last_name else ""
        user_data = {
            "first_name": first_name or "",
            "last_name_initial": last_initial,
            "role": role or "",
            "status": "green",
            "games_last_30_days": 0
        }
        logger.debug("[8.0] get_user_info: –ó–∞–≥—Ä—É–∂–µ–Ω '%s' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %d", role, user_id)
        return user_data

    except Exception as e:
        logger.error("[8.0] get_user_info: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–ª—è %d: %s", user_id, e, exc_info=True)
        return None

def get_lead_name(lead_id: str) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–º—è –≤–µ–¥—É—â–µ–≥–æ –ø–æ ID.

    Args:
        lead_id: ID –≤–µ–¥—É—â–µ–≥–æ.

    Returns:
        str: –ò–º—è –≤–µ–¥—É—â–µ–≥–æ.
    """
    try:
        logger.debug("[8.0] get_lead_name: –ó–∞–ø—Ä–æ—à–µ–Ω–æ –∏–º—è –¥–ª—è lead_id %s", lead_id)
        return "Unknown Lead"
    except Exception as e:
        logger.error("[8.0] get_lead_name: –û—à–∏–±–∫–∞ –¥–ª—è lead_id %s: %s", lead_id, e, exc_info=True)
        return "Unknown Lead"

# version: 1.3
# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# - 1.0: –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–ª—É—à–∫–∏.
# - 1.1 (11.05.2025): –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–¥–µ–ª–æ–º.
# - 1.2 (12.05.2025): –†–µ–∞–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ —Ä–æ–ª—å ¬´—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å¬ª –¥–ª—è LEADER_ID.
# - 1.3 (12.05.2025): –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ checklists.db –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è first_name, last_name –∏ role.

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                        [9.0] –ú–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö                               ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ –¥–ª—è pipeline –∏ —Å—Ç–∞—Ç—É—Å–æ–≤.
# version: 1.1

async def generate_name_mapping() -> None:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∞–ø–ø–∏–Ω–≥ pipeline –∏ —Å—Ç–∞—Ç—É—Å–æ–≤."""
    try:
        bot_data.pipeline_mapping = {
            "pipeline_id": {
                "name": "Main Pipeline",
                "stages": {
                    "142": "New",
                    "18913933": "In Progress",
                    "18913930": "Successful"
                }
            }
        }
        logger.info("[9.0] generate_name_mapping: –ú–∞–ø–ø–∏–Ω–≥ pipeline —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
    except Exception as e:
        logger.error("[9.0] generate_name_mapping: –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∞–ø–ø–∏–Ω–≥–∞: %s", e, exc_info=True)
        
# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                  [10.0] Telegram-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏  (v3.3 ‚Äì 12-06-2025)         ‚ïë
# ‚ïë  /start ¬∑ ¬´üìÖ –ù–æ–≤—ã–µ –∏–≥—Ä—ã¬ª ¬∑ ¬´‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∏–≥—Ä—ã¬ª ¬∑ ¬´üìã –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å¬ª    ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïë  –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:                                                      ‚ïë
# ‚ïë  ‚Ä¢ _refresh_menu –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ä–æ–≤–Ω–æ –û–î–ù–£ ¬´–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è¬ª:              ‚ïë
# ‚ïë      ‚Äì —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –º–µ–Ω—é —á–µ—Ä–µ–∑ edit_message_text ‚ïë
# ‚ïë      ‚Äì –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä–æ–µ –∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ                         ‚ïë
# ‚ïë      ‚Äì —Å—Ç–∞—Ä—ã–π message_id –∫–ª–∞–¥—ë—Ç –≤ messages_to_delete ‚Üí vacuum —É–±–µ—Ä—ë—Ç      ‚ïë
# ‚ïë  ‚Ä¢ vacuum –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç menu_message_id                         ‚ïë
# ‚ïë  ‚Ä¢ –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (triggers, –¥–æ—Å—Ç—É–ø—ã) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π                    ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
from aiogram.types import ReplyKeyboardRemove
from datetime import datetime, timedelta

router = Router()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helper: –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def _delete_trigger(msg: types.Message) -> None:
    try:
        await msg.delete()
    except Exception:
        bot_data.messages_to_delete.setdefault(msg.from_user.id, []).append(msg.message_id)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helper: ¬´—Ç–∏—Ö–æ–µ¬ª –º–µ–Ω—é ‚Äî —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# v1.5 ‚Äî –±–µ–∑ —Ç–µ–∫—Å—Ç–∞. –¢–æ–ª—å–∫–æ reply_markup.
async def _refresh_menu(user_id: int) -> None:
    kb = await get_main_menu(user_id)
    if not kb:
        return

    old_id = getattr(bot_data, "menu_message_id", None)

    # ‚ñ∂ –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –º–µ–Ω—é
    if old_id:
        try:
            await bot.edit_message_text(
                text="‚Äé",  # U+200E ‚Äî –Ω–µ–≤–∏–¥–∏–º—ã–π —Å–∏–º–≤–æ–ª
                chat_id=user_id,
                message_id=old_id,
                reply_markup=kb
            )
            return
        except TelegramBadRequest as e:
            if "message is not modified" in str(e):
                return
        except Exception:
            pass

        try:
            await bot.delete_message(chat_id=user_id, message_id=old_id)
        except Exception:
            pass
        bot_data.messages_to_delete.setdefault(user_id, []).append(old_id)
        bot_data.menu_message_id = None

    # ‚ñ∂ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –º–µ–Ω—é –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
    try:
        sent = await bot.send_message(
            chat_id=user_id,
            text="‚Äé",  # invisible text again
            reply_markup=kb
        )
        bot_data.menu_message_id = sent.message_id
        logger.debug("[10.0] _refresh_menu: –Ω–æ–≤–æ–µ –ø—É—Å—Ç–æ–µ –º–µ–Ω—é id=%d", sent.message_id)
    except Exception as e:
        logger.error("[10.0] _refresh_menu: —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å: %s", e, exc_info=True)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ /start ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@router.message(CommandStart())
async def start_handler(message: types.Message) -> None:
    uid = message.from_user.id
    try:
        # vacuum —É–¥–∞–ª–∏—Ç –≤—Å—ë, –∫—Ä–æ–º–µ (–±—É–¥—É—â–µ–≥–æ) –º–µ–Ω—é
        await delete_previous_private_messages(uid)

        kb  = await get_main_menu(uid)
        txt = (
            f"üéâ –ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}!\n"
            f"–Ø *MasterBot* {VERSION} ü§ñ\n"
            f"–¢–≤–æ–π ID: `{uid}`\n"
        )
        if not kb:
            txt += "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É —Ç–µ–±—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π."
        else:
            txt += "–Ø –ø–æ–º–æ–≥—É —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –≤–µ–¥—É—â–∏—Ö –Ω–∞ –∫–≤–µ—Å—Ç—ã."

        # show greeting (–Ω–µ –ø—É—Ç–∞—Ç—å —Å –º–µ–Ω—é)
        await message.answer(txt, reply_markup=kb or ReplyKeyboardRemove())
        await _delete_trigger(message)                # —Å–∫—Ä—ã–≤–∞–µ–º /start

        # –º–µ–Ω—é —Å–æ–∑–¥–∞—ë—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
        await _refresh_menu(uid)
    except Exception as e:
        logger.error("[10.0] start_handler: %s", e, exc_info=True)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –±—ã—Å—Ç—Ä—ã–µ –º–µ–Ω—é-–∫–æ–º–∞–Ω–¥—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@router.message(lambda m: m.text and m.text.strip() in {"üìÖ –ù–æ–≤—ã–µ –∏–≥—Ä—ã", "\U0001F4C5 –ù–æ–≤—ã–µ –∏–≥—Ä—ã"})
async def new_games_handler(message: types.Message) -> None:
    uid = message.from_user.id
    if (info := get_user_info(uid)) and info["role"] in ACCESS["games"]:
        await delete_previous_private_messages(uid)
        await show_games(message, uid, NEW_GAMES_STATUS_IDS, "üìÖ –ù–æ–≤—ã–µ –∏–≥—Ä—ã:", True)
    else:
        await message.answer("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.", reply_markup=await get_main_menu(uid))
    await _delete_trigger(message)

@router.message(lambda m: m.text and m.text.strip() == "‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∏–≥—Ä—ã")
async def assigned_games_handler(message: types.Message) -> None:
    uid = message.from_user.id
    if (info := get_user_info(uid)) and info["role"] in ACCESS["games"]:
        await delete_previous_private_messages(uid)
        await show_games(message, uid, [SUCCESSFUL_STATUS_ID], "‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∏–≥—Ä—ã:")
    else:
        await message.answer("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.", reply_markup=await get_main_menu(uid))
    await _delete_trigger(message)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ üìã –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å (—Ñ–∏–∫—Å ¬´–º–µ–Ω—é –ø—Ä–æ–ø–∞–¥–∞–ª–æ¬ª) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@router.message(lambda m: m.text and m.text.strip() == "üìã –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å")
async def create_poll_handler(message: types.Message) -> None:
    uid = message.from_user.id

    # ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ ‚Äî
    if not await has_access(uid, "poll"):
        await message.answer("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.", reply_markup=await get_main_menu(uid))
        await _delete_trigger(message); return
    if bot_data.coordination_cycle_active:
        await message.answer("‚ö†Ô∏è –£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –æ–ø—Ä–æ—Å.")
        await _delete_trigger(message); return
    if not bot_data.admin_chat_id or not await is_bot_admin(bot_data.admin_chat_id):
        await message.answer("‚ö†Ô∏è –ß–∞—Ç –≤–µ–¥—É—â–∏—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –±–æ—Ç –Ω–µ –∞–¥–º–∏–Ω.")
        await _delete_trigger(message); return
    if not (sid := bot_data.config.get("svetofor_spread_id")):
        await message.answer("‚ö†Ô∏è –ù–µ —É–∫–∞–∑–∞–Ω ID —Ç–∞–±–ª–∏—Ü—ã ¬´–°–≤–µ—Ç–æ—Ñ–æ—Ä¬ª.")
        await _delete_trigger(message); return

    await delete_previous_private_messages(uid)

    # ‚Äî —Å–æ–±–∏—Ä–∞–µ–º —Å–¥–µ–ª–∫–∏ ‚Äî
    deals = await get_amocrm_deals(sid)
    now, window_end = datetime.now(tz=MSK_TZ), datetime.now(tz=MSK_TZ) + timedelta(days=14)
    poll_deals = [
        d for d in deals
        if d["status_id"] in NEW_GAMES_STATUS_IDS
           and now <= d["event_datetime"] <= window_end
           and not d["team_leads"]
    ]
    if not poll_deals:
        await message.answer("üòî –ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∏–≥—Ä –¥–ª—è –æ–ø—Ä–æ—Å–∞.",
                             reply_markup=await get_main_menu(uid))
        await _delete_trigger(message); return

    # ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø—Ä–æ—Å–∞ ‚Äî
    bot_data.current_poll_deals        = poll_deals
    bot_data.current_poll_leader       = uid
    bot_data.responses.clear()
    bot_data.distribution_cache.clear()
    bot_data.coordination_cycle_active = True     # ‚Üê –∫–Ω–æ–ø–∫–∞ ¬´üìä¬ª –≤ –º–µ–Ω—é

    # ‚Äî –ø—É–±–ª–∏–∫—É–µ–º poll-—Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî
    urgent      = any(d["event_datetime"] <= now + timedelta(days=3) for d in poll_deals)
    base_header = "üö® –°—Ä–æ—á–Ω—ã–µ –∏–≥—Ä—ã!" if urgent else "üìä –ù–æ–≤—ã–µ –∏–≥—Ä—ã"
    chunks      = [poll_deals[i:i + 8] for i in range(0, len(poll_deals), 8)]

    for idx, chunk in enumerate(chunks, 1):
        header  = f"{base_header} (–ß–∞—Å—Ç—å {idx})" if len(chunks) > 1 else base_header
        options, indices = [], {}
        for i, d in enumerate(chunk):
            date  = d["event_datetime"].strftime("%d.%m")
            title = f"üéâ {d['name']} ‚Äì {date}"
            if d["package"]:         title += f" ‚Äì {d['package']}"
            if d["extra_services"]:
                rest  = 100 - len(title) - 1
                extra = d["extra_services"]
                if len(extra) > rest:
                    extra = extra[:rest - 1].rstrip(', ') + "‚Ä¶"
                title += f" {extra}"
            options.append(title[:100]); indices[i] = d["id"]

        options += ["üö´ –ù–µ —Å–º–æ–≥—É —Ä–∞–±–æ—Ç–∞—Ç—å", "üõ°Ô∏è –ú–æ–≥—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"]

        poll_msg = await bot.send_poll(
            bot_data.admin_chat_id, header, options,
            is_anonymous=False, allows_multiple_answers=True
        )
        bot_data.responses[poll_msg.poll.id] = {
            "deals":           {d["id"]: [] for d in chunk},
            "admin_available": [],
            "not_available":   [],
            "deal_indices":    indices
        }

    # ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —á–∏—Å—Ç–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞ ‚Äî
    ok = await message.answer("‚úÖ –û–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.")          # –±–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã!
    bot_data.messages_to_delete.setdefault(uid, []).extend([message.message_id, ok.message_id])

    # ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –º–µ–Ω—é ‚Äî
    await _refresh_menu(uid)

    # ‚Äî –ª–∏—á–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ ‚Äî
    dash = await bot.send_message(
        uid,
        await generate_poll_report(),
        reply_markup=bot_data.distribution_keyboard,
        parse_mode="Markdown"
    )
    bot_data.last_user_messages[uid]   = [dash]
    bot_data.personal_report_message_id = dash.message_id

    await report_unknown_names()

    scheduler.add_job(
        clear_poll_data,
        "date",
        run_date=now + POLL_DURATION,
        args=[uid],
        id=f"clear_poll_{uid}",
        replace_existing=True
    )

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë               [10.1] poll_report_handler  (v1.3)                         ‚ïë
# ‚ïë  ¬´üìä –û—Ç—á—ë—Ç –ø–æ –æ–ø—Ä–æ—Å—É¬ª ‚Äì –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –º–µ–Ω—é –æ—Å—Ç–∞—ë—Ç—Å—è.            ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
@router.message(lambda m: m.text and m.text.strip() in {"üìä –û—Ç—á—ë—Ç –ø–æ –æ–ø—Ä–æ—Å—É", "\U0001F4CA –û—Ç—á—ë—Ç –ø–æ –æ–ø—Ä–æ—Å—É"})
async def poll_report_handler(message: types.Message) -> None:
    uid = message.from_user.id
    if not await has_access(uid, "poll"):
        await message.answer("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.", reply_markup=await get_main_menu(uid))
        await _delete_trigger(message); return
    if not bot_data.coordination_cycle_active:
        await message.answer("‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç.", reply_markup=await get_main_menu(uid))
        await _delete_trigger(message); return

    await delete_previous_private_messages(uid)

    dash = await bot.send_message(
        uid,
        await generate_poll_report(),
        reply_markup=bot_data.distribution_keyboard,
        parse_mode="Markdown"
    )
    bot_data.last_user_messages[uid]          = [dash]
    bot_data.personal_report_message_id       = dash.message_id
    bot_data.messages_to_delete.setdefault(uid, []).append(dash.message_id)

    await _refresh_menu(uid)                  # –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É ¬´üìä¬ª ‚Üí ¬´üìä¬ª (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    await _delete_trigger(message)


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë          [11.0] game_details_handler (v2.0 ‚Äî single-screen fix)          ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –∏–≥—Ä—ã –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤ –õ–° –æ—Å—Ç–∞—ë—Ç—Å—è –û–î–ù–û —Å–æ–æ–±—â–µ–Ω–∏–µ.
# version: 2.0 (08.06.2025)

@router.callback_query(lambda c: c.data.startswith("game_details_"))
async def game_details_handler(callback: types.CallbackQuery) -> None:
    user_id  = callback.from_user.id
    deal_id  = int(callback.data.split("_")[-1])

    try:
        # ‚ûä –ß–∏—Å—Ç–∏–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ ¬´–æ–∫–Ω–æ¬ª
        await delete_previous_private_messages(user_id)

        # ‚ûã –ò—â–µ–º —Å–¥–µ–ª–∫—É (–≤ –∫–µ—à–µ show_games –∏–ª–∏ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –æ–ø—Ä–æ—Å–µ)
        deal = next(
            (d for d in bot_data.games_by_user.get(user_id, []) if d["id"] == deal_id),
            next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        )
        if not deal:
            await callback.answer("‚ö†Ô∏è –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
            return

        # ‚ûå –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        date_part    = deal["event_datetime"].strftime("%d.%m.%Y")
        time_part    = deal.get("event_time", "‚Äî")
        quest        = deal.get("game_name", "‚Äî")
        package      = deal.get("package", "‚Äî")
        status       = deal.get("status", "‚Äî")
        players      = deal.get("players", "‚Äî")
        age          = deal.get("age", "‚Äî")
        extra        = deal.get("extra_services", "‚Äî")
        comment      = deal.get("comment", "‚Äî")
        prepay       = deal.get("prepayment", 0)
        leads        = ", ".join(l["name"] for l in deal.get("team_leads", [])) or "‚Äî"
        photographer = deal.get("photographer", "‚Äî")
        total_budget = deal.get("total_budget", 0)
        to_calc      = deal.get("to_calculate", 0)

        text = "\n".join([
            f"üéÆ *–ò–≥—Ä–∞*: {quest}",
            f"üéÅ *–ü–∞–∫–µ—Ç —É—Å–ª—É–≥*: {package}",
            f"üîñ *–°—Ç–∞—Ç—É—Å*: {status}",
            f"üìÖ *–î–∞—Ç–∞*: {date_part}",
            f"üïí *–í—Ä–µ–º—è*: {time_part}",
            f"üë• *–ò–≥—Ä–æ–∫–∏*: {players}",
            f"‚ö†Ô∏è *–í–æ–∑—Ä–∞—Å—Ç*: {age}",
            f"‚ûï *–î–æ–ø. —É—Å–ª—É–≥–∏*: {extra}",
            f"üí¨ *–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π*: {comment}",
            f"üí∏ *–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞*: {prepay} ‚ÇΩ",
            f"üßë‚Äçü§ù‚Äçüßë *–í–µ–¥—É—â–∏–µ*: {leads}",
            f"üì∑ *–§–æ—Ç–æ–≥—Ä–∞—Ñ*: {photographer}",
            f"üí∞ *–ë—é–¥–∂–µ—Ç*: {total_budget} ‚ÇΩ",
            f"üßÆ *–ö —Ä–∞—Å—á—ë—Ç—É*: {to_calc} ‚ÇΩ",
        ])

        # ‚ûç –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª
        kb = InlineKeyboardBuilder()
        kb.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", callback_data="back_to_games_list")
        kb.adjust(1)

        sent = await callback.message.answer(text, reply_markup=kb.as_markup(), parse_mode="Markdown")

        # ‚ûé –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –≠–¢–û —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–µ
        bot_data.last_user_messages[user_id] = [sent]

        await callback.answer()

    except Exception as e:
        logger.error("[11.0] game_details_handler v2.0: %s", e, exc_info=True)
        await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–µ—Ç–∞–ª–µ–π.", show_alert=True)

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                   [11.1] back_to_games_list_handler (v1.1)               ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# ¬´‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É¬ª —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—ã–ª–µ—Å–æ—Å.
# version: 1.1 (08.06.2025)

@router.callback_query(lambda c: c.data == "back_to_games_list")
async def back_to_games_list_handler(callback: types.CallbackQuery) -> None:
    user_id = callback.from_user.id
    try:
        # üßπ —É–±–∏—Ä–∞–µ–º –¥–µ—Ç–∞–ª–∏, —á—Ç–æ–±—ã –æ—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫
        await delete_previous_private_messages(user_id)

        games = bot_data.games_by_user.get(user_id)
        if not games:
            await callback.answer("üòî –°–ø–∏—Å–æ–∫ –∏–≥—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.", show_alert=True)
            return

        kb = InlineKeyboardBuilder()
        for d in games:
            btn_text = f"üéâ {d['name']} {d['event_time']}"
            kb.button(text=btn_text, callback_data=f"game_details_{d['id']}")
        kb.adjust(1)

        sent = await callback.message.answer(
            "üìã –°–ø–∏—Å–æ–∫ –∏–≥—Ä:\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:", reply_markup=kb.as_markup()
        )

        # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        bot_data.last_user_messages[user_id] = [sent]

        await callback.answer()
    except Exception as e:
        logger.error("[11.1] back_to_games_list_handler: %s", e, exc_info=True)
        await callback.answer("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É.", show_alert=True)


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                  [11.2] report_back_handler (‚¨ÖÔ∏è –ù–∞–∑–∞–¥)                    ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä –∏–∑ –æ—Ç—á—ë—Ç–∞, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–ù–∞–∑–∞–¥¬ª
# version: 1.0 (30.05.2025)

@router.callback_query(lambda c: c.data == "report_back")
async def report_back_handler(callback: types.CallbackQuery) -> None:
    """–í–æ–∑–≤—Ä–∞—Ç –∏–∑ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –ø–æ –∏–≥—Ä–µ –∫ —Å–ø–∏—Å–∫—É –∏–≥—Ä-–∫–Ω–æ–ø–æ–∫."""
    try:
        await callback.message.delete()                 # —É–±–∏—Ä–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
        # –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º ¬´–≥–ª–∞–≤–Ω—É—é¬ª –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –æ—Ç—á—ë—Ç–∞
        await bot.edit_message_text(
            await generate_poll_report(),
            chat_id=callback.from_user.id,
            message_id=bot_data.personal_report_message_id,
            reply_markup=bot_data.distribution_keyboard,
            parse_mode="Markdown"
        )
        await callback.answer()
    except Exception:
        # –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        await callback.answer()

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                           [12.0] –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã                              ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# version: 1.5 (08.06.2025) ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´üìã –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å¬ª ‚Üí ¬´üìä –û—Ç—á—ë—Ç –ø–æ –æ–ø—Ä–æ—Å—É¬ª
#   ‚Ä¢ –µ—Å–ª–∏ bot_data.coordination_cycle_active == True, –≤ –º–µ–Ω—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
#     –æ—Ç—á—ë—Ç; –∏–Ω–∞—á–µ ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞.

from typing import List, Optional
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils.keyboard import ReplyKeyboardBuilder   # aiogram 3.x builder

async def get_main_menu(user_id: int) -> Optional[ReplyKeyboardMarkup]:
    """–°–æ–∑–¥–∞—ë—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–ø—Ä–æ—Å–∞."""
    try:
        user_info = get_user_info(user_id) or {}
        role = user_info.get("role", "")

        btns: List[KeyboardButton] = []

        if role in ACCESS["games"]:
            btns.extend([
                KeyboardButton(text="\U0001F4C5 –ù–æ–≤—ã–µ –∏–≥—Ä—ã"),
                KeyboardButton(text="\U00002705 –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∏–≥—Ä—ã")
            ])

        if role in ACCESS["poll"]:
            if bot_data.coordination_cycle_active:
                # –∏–¥—ë—Ç –∞–∫—Ç–∏–≤–Ω—ã–π –æ–ø—Ä–æ—Å ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á—ë—Ç
                btns.append(KeyboardButton(text="\U0001F4CA –û—Ç—á—ë—Ç –ø–æ –æ–ø—Ä–æ—Å—É"))
            else:
                # –æ–ø—Ä–æ—Å–∞ –Ω–µ—Ç ‚Üí –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
                btns.append(KeyboardButton(text="\U0001F4CB –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å"))

        if not btns:
            logger.warning("[12.0] get_main_menu: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –¥–ª—è %d, role=%s",
                           user_id, role)
            return None

        builder = ReplyKeyboardBuilder()
        builder.add(*btns)
        builder.adjust(2)
        return builder.as_markup(resize_keyboard=True)

    except Exception as exc:
        logger.error("[12.0] get_main_menu: –û—à–∏–±–∫–∞ –¥–ª—è %d: %s", user_id, exc, exc_info=True)
        return None

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                     [12.1] –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è                       ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –µ–¥–∏–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∫ –ª–∏—á–Ω–æ–º—É –æ—Ç—á—ë—Ç—É —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è
#           (¬´üëå –£—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª, ¬´üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª, ¬´üîß –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é¬ª)
#           –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ create_poll_handler —á–µ—Ä–µ–∑ get_distribution_keyboard()
# version: 1.0 (30.05.2025)

def get_distribution_keyboard() -> InlineKeyboardMarkup:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–¥ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º."""
    kb = InlineKeyboardBuilder()
    kb.button(text="üëå –£—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ",
              callback_data="distribute_leaders")
    kb.button(text="üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ AmoCRM",
              callback_data="save_distribution")
    kb.button(text="üîß –ò–∑–º–µ–Ω–∏—Ç—å —Å–æ—Å—Ç–∞–≤ –≤—Ä—É—á–Ω—É—é",
              callback_data="manual_edit")
    kb.adjust(1)          # –∫–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –≤ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
    return kb.as_markup()

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                [13.0] generate_poll_report  (v6.5 ‚Äì 11-06-2025)           ‚ïë
# ‚ïë  ‚Ä¢ each user counted –º–∞–∫—Å–∏–º—É–º –≤ –û–î–ù–£ —Ä–æ–ª—å (greedy-–∞–ª–≥–æ—Ä–∏—Ç–º)              ‚ïë
# ‚ïë  ‚Ä¢ admin_available + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

def _get_role_cfg(game_name: str) -> dict[str, int]:
    clean = game_name.strip().lower()
    for title, cfg in GAME_ROLE_MAPPING.items():
        if title.lower() == clean:
            return cfg
    return {"main_leaders": 1, "assistants": 0}

def _is_real_admin(uid: int) -> bool:
    role = (get_user_info(uid) or {}).get("role", "").lower()
    return role in {"–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", "—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å"}

async def generate_poll_report() -> str:
    if not bot_data.current_poll_deals or not bot_data.responses:
        return "‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤."

    keyboard: list[list[InlineKeyboardButton]] = []

    # ¬´–≥–ª–æ–±–∞–ª—å–Ω—ã–µ¬ª –∞–¥–º–∏–Ω—ã (admin_available)
    poll_admins = [
        u for pdata in bot_data.responses.values() for u in pdata["admin_available"]
        if _is_real_admin(u["user_id"])
    ]

    for deal in bot_data.current_poll_deals:
        did        = deal["id"]
        game       = deal["game_name"]
        date_str   = deal["event_datetime"].strftime("%d.%m")
        pkg_lower  = (deal.get("package") or "").strip().lower()

        cfg              = _get_role_cfg(game)
        need_main        = cfg["main_leaders"]
        need_assist      = cfg["assistants"]
        need_admin       = 1 if pkg_lower in {"—Å—Ç–∞–Ω–¥–∞—Ä—Ç", "—Å—Ç–∞–Ω–¥–∞—Ä—Ç+", "–ø—Ä–µ–º–∏—É–º", "vip", "–≤–∏–ø"} else 0

        # --------- —Å–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç–æ–≤ --------
        respondents: dict[int, dict] = {}
        for pdata in bot_data.responses.values():
            for u in pdata["deals"].get(did, []):
                respondents[u["user_id"]] = u
        for u in poll_admins:
            respondents.setdefault(u["user_id"], u)

        have_main = have_assist = have_admin = 0
        # greedy-—Ä–∞—Å–∫–ª–∞–¥: —Å–Ω–∞—á–∞–ª–∞ main, –ø–æ—Ç–æ–º assist
        for u in respondents.values():
            if u.get("is_admin_eligible") and have_admin < need_admin:
                have_admin += 1
                continue

            status = await get_user_status_from_svetofor(u["user_id"], game)
            if status == "green":
                if have_main < need_main:
                    have_main += 1
                elif have_assist < need_assist:
                    have_assist += 1
            elif status == "yellow" and have_assist < need_assist:
                have_assist += 1

        ready = (have_main >= need_main and
                 have_assist >= need_assist and
                 have_admin >= need_admin)
        icon = "‚úÖ" if ready else "‚ùå"
        keyboard.append([InlineKeyboardButton(
            text=f"{icon} {game} ‚Äî {date_str}",
            callback_data=f"show_deal_{did}"
        )])

    bot_data.distribution_keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard)
    return "üìä *–û–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:*"

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë        [13.0.1] show_deal_callback_handler  (v5.11 ‚Äì 11-06-2025)          ‚ïë
# ‚ïë  ‚Ä¢ –ü–æ—Å–ª–µ –∫–ª–∏–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è –∏ —Å–ø–∏—Å–æ–∫-—Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —Å—Ç–∞—Ä—ã–µ –¥–µ—Ç–∞–ª–∏              ‚ïë
# ‚ïë  ‚Ä¢ respondents ‚Üí dict (–±–µ–∑ –¥—É–±–ª–µ–π)                                        ‚ïë
# ‚ïë  ‚Ä¢ –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π                               ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
@router.callback_query(lambda c: c.data.startswith("show_deal_"))
async def show_deal_callback_handler(callback: types.CallbackQuery) -> None:
    user_id = callback.from_user.id
    deal_id = int(callback.data.split("_")[-1])

    try:
        # ‚ûä –£–¥–∞–ª—è–µ–º –≤—Å—ë —Å—Ç–∞—Ä–æ–µ (—Å–ø–∏—Å–∫–∏, –¥–µ—Ç–∞–ª–∏, ¬´—Å–∏—Ä–æ—Ç—ã¬ª)
        await delete_previous_private_messages(user_id)

        # ‚ûä.1 –£–¥–∞–ª—è–µ–º —Å–∞–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—ã–ª –∫–ª–∏–∫
        try:
            await callback.message.delete()
        except Exception:
            pass                                     # —É–∂–µ —É–¥–∞–ª—ë–Ω / –Ω–µ –Ω–∞—à ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º

        # ‚ûã –ò—â–µ–º —Å–¥–µ–ª–∫—É
        deal = next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        if not deal:
            if callback.id != "refresh":
                await callback.answer("‚ö†Ô∏è –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
            return

        # ‚ûå –ó–∞–≥–æ–ª–æ–≤–æ–∫
        game   = deal["game_name"]
        date   = deal["event_datetime"].strftime("%d.%m.%Y")
        time   = deal.get("event_time", "‚Äî")
        pkg    = (deal.get("package") or "‚Äî").strip()
        pkg_i  = {"–∫–æ–º–ø–∞–∫—Ç": "üéí", "—Å—Ç–∞–Ω–¥–∞—Ä—Ç": "üì¶", "—Å—Ç–∞–Ω–¥–∞—Ä—Ç+": "üì¶‚ûï",
                  "–ø—Ä–µ–º–∏—É–º": "üíé", "vip": "üëë", "–≤–∏–ø": "üëë"}.get(pkg.lower(), "üéÅ")
        players = parse_players_count(deal.get("players"))

        msgs = [await bot.send_message(
            user_id,
            f"üéÆ *{game}*\nüìÖ {date} ¬∑ üïí {time}\n"
            f"üì¶ *–ü–∞–∫–µ—Ç:* {pkg_i} {pkg}\n"
            f"üë• *–ò–≥—Ä–æ–∫–∏:* {players or '‚Äî'}",
            parse_mode="Markdown"
        )]

        # ‚ûç –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—ã -----------------------------------------
        resp: dict[int, dict] = {
            u["user_id"]: u
            for pdata in bot_data.responses.values()
            for u in pdata["deals"].get(deal_id, [])
        }
        # + –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∞–¥–º–∏–Ω—ã
        for pdata in bot_data.responses.values():
            for adm in pdata["admin_available"]:
                role = (get_user_info(adm["user_id"]) or {}).get("role", "").lower()
                if role in {"–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", "—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å"}:
                    resp.setdefault(adm["user_id"], adm)

        cfg          = _get_role_cfg(game)
        need_main    = cfg["main_leaders"]
        need_assist  = cfg["assistants"]
        need_admin   = 1 if pkg.lower() in {"—Å—Ç–∞–Ω–¥–∞—Ä—Ç", "—Å—Ç–∞–Ω–¥–∞—Ä—Ç+", "–ø—Ä–µ–º–∏—É–º", "vip", "–≤–∏–ø"} else 0
        used: set[int] = set()

        async def render(title: str, rtype: str, req: int) -> None:
            chosen, alt = [], []
            for u in resp.values():
                if u["user_id"] in used:
                    continue
                status = await get_user_status_from_svetofor(u["user_id"], game)

                if rtype == "main" and status == "green":
                    (chosen if len(chosen) < req else alt).append((u, "üü¢"))
                elif rtype == "assist" and status in {"green", "yellow"}:
                    mark = "üü¢" if status == "green" else "üü°"
                    (chosen if len(chosen) < req else alt).append((u, mark))
                elif rtype == "admin" and u.get("is_admin_eligible"):
                    (chosen if len(chosen) < req else alt).append((u, "üõ°Ô∏è"))

            icon   = {"main": "üß≠", "assist": "üõü", "admin": "üõ°Ô∏è"}[rtype]
            block  = [f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ {icon} *{title.upper()}* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
                      f"{'‚úÖ' if len(chosen) >= req else '‚ùå'} {len(chosen)}/{req}"]
            if not chosen:
                block.append("‚Äì ‚Äî")
            for u, mark in chosen:
                used.add(u["user_id"])
                block.append(f"‚Äì {u['first_name']} {u['last_name_initial']} {mark}")

            msgs.append(await bot.send_message(user_id, "\n".join(block), parse_mode="Markdown"))

            if alt:
                kb = InlineKeyboardBuilder()
                for u, mark in alt:
                    kb.button(text=f"{u['first_name']} {u['last_name_initial']} {mark}",
                              callback_data=f"swap_{deal_id}_{rtype}_{u['user_id']}")
                kb.adjust(1)
                msgs.append(await bot.send_message(
                    user_id, "üîÅ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:", reply_markup=kb.as_markup()
                ))

        await render("–í–µ–¥—É—â–∏–µ",   "main",   need_main)
        await render("–ü–æ–º–æ—â–Ω–∏–∫–∏", "assist", need_assist)
        await render("–ê–¥–º–∏–Ω",     "admin",  need_admin)

        # ‚ûé –°—Ç–∞–∂—ë—Ä—ã ---------------------------------------------------------
        interns = [u for u in resp.values()
                   if u["user_id"] not in used and
                   await get_user_status_from_svetofor(u["user_id"], game) == "red"]
        if interns:
            block = ["‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ üë∑ *–°–¢–ê–ñ–Å–†–´* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"] + [
                f"‚Äì {u['first_name']} {u['last_name_initial']} üî¥" for u in interns
            ]
            msgs.append(await bot.send_message(user_id, "\n".join(block), parse_mode="Markdown"))

        # ‚ûè ¬´–ù–∞–∑–∞–¥¬ª ---------------------------------------------------------
        kb_back = InlineKeyboardBuilder()
        kb_back.button(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", callback_data="back_to_games_list")
        kb_back.adjust(1)
        msgs.append(await bot.send_message(user_id, "‚¨ÖÔ∏è", reply_markup=kb_back.as_markup()))

        # ‚ûê –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –±—É–¥—É—â–µ–≥–æ vacuum
        bot_data.last_user_messages[user_id] = msgs
        bot_data.detail_blocks[(user_id, deal_id)] = msgs

        if callback.id != "refresh":
            await callback.answer()

    except Exception as exc:
        logger.error("[13.0.1] show_deal_callback_handler v5.11: %s", exc, exc_info=True)
        if callback.id != "refresh":
            await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞.", show_alert=True)

# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# v5.11 ‚Äì 11-06-2025 ‚Äî —É–¥–∞–ª—è–µ–º —Å–ø–∏—Å–æ–∫-—Å–æ–æ–±—â–µ–Ω–∏–µ; vacuum —Ç–µ–ø–µ—Ä—å —á–µ—Å—Ç–Ω–æ –æ—á–∏—â–∞–µ—Ç —ç–∫—Ä–∞–Ω.
# v5.10 ‚Äì 11-06-2025 ‚Äî respondents dict + TypeError fix.



# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                  [13.0.1.1] assign_swap_handler  (v1.3)                  ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

@router.callback_query(lambda c: c.data.startswith("swap_"))
async def assign_swap_handler(callback: types.CallbackQuery) -> None:
    try:
        _, deal_id_str, role_type, new_user_id_str = callback.data.split("_", 3)
        deal_id     = int(deal_id_str)
        new_user_id = int(new_user_id_str)

        deal = next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        if not deal:
            await callback.answer("‚ö†Ô∏è –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
            return

        role_prefix = {"main": "lead", "assist": "assistant", "admin": "admin"}.get(role_type)
        if not role_prefix:
            await callback.answer("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Ä–æ–ª–∏.", show_alert=True)
            return

        dist = bot_data.distribution_cache.setdefault(str(deal_id), {})

        # –∏—â–µ–º –ø–µ—Ä–≤—ã–π —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞
        role_key = None
        for i in range(1, 5):
            key = f"{role_prefix}{i}" if role_prefix != "admin" else "admin"
            if key not in dist or not dist[key]:
                role_key = key
                break
        if not role_key:
            await callback.answer("‚ö†Ô∏è –°–≤–æ–±–æ–¥–Ω–∞—è —Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
            return

        user_info = get_user_info(new_user_id)
        if not user_info:
            await callback.answer("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            return

        name   = f"{user_info['first_name']} {user_info['last_name_initial']}"
        suffix = {"lead": ".1", "assistant": ".–ü–æ–º", "admin": ".–ê–¥"}.get(role_prefix, "")
        dist[role_key] = f"{name}{suffix}"

        await callback.answer("‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.")
        # –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –¥–µ—Ç–∞–ª–µ–π
        await show_deal_callback_handler(callback)

    except Exception as e:
        logger.error("[13.0.1.1] assign_swap_handler: %s", e, exc_info=True)
        await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–º–µ–Ω–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞.", show_alert=True)


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                [13.0.1.2] refresh_deal_details  (helper)                 ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
async def refresh_deal_details(user_id: int, deal_id: int) -> None:
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –¥–µ—Ç–∞–ª–µ–π –∏–≥—Ä—ã.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è assign_swap_handler –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ show_deal –≤—ã–∑–æ–≤—ã.
    """
    msgs = bot_data.detail_blocks.get((user_id, deal_id))
    if not msgs:
        return  # –Ω–µ—á–µ–≥–æ –æ–±–Ω–æ–≤–ª—è—Ç—å

    header_msg = msgs[0]
    # –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å: —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫—Ä–æ–º–µ header
    for m in msgs[1:]:
        try:
            await m.delete()
        except Exception:
            pass
    msgs[:] = msgs[:1]  # –æ—Å—Ç–∞–≤–∏–ª–∏ —Ç–æ–ª—å–∫–æ header

    # –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º show_deal –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ (–±–µ–∑ –º–µ—Ä—Ü–∞–Ω–∏—è)
    dummy_cb = types.CallbackQuery(
        id="refresh", from_user=types.User(id=user_id, is_bot=False, first_name=""),
        chat_instance="", message=header_msg, data=f"show_deal_{deal_id}"
    )
    await show_deal_callback_handler(dummy_cb)



# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                   [13.0.2] distribute_leaders_handler                     ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑ –∫—ç—à–∞
#           (–Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å –Ω—É–ª—è, –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç create_distribution)
# version: 4.0 (28.05.2025) ‚Äî —á–∏—Ç–∞–µ—Ç –∏–∑ distribution_cache

@router.callback_query(lambda c: c.data == "distribute_leaders")
async def distribute_leaders_handler(callback: types.CallbackQuery) -> None:
    user_id = callback.from_user.id
    logger.debug("[13.0.2] distribute_leaders_handler: start for user %d", user_id)

    try:
        if not await has_access(user_id, "poll"):
            await callback.answer("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.", show_alert=True)
            return
        if not bot_data.coordination_cycle_active:
            await callback.answer("‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞.", show_alert=True)
            return

        if not bot_data.distribution_cache:
            await callback.answer("‚ö†Ô∏è –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.", show_alert=True)
            return

        report = ["üìã *–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:*"]

        for deal in bot_data.current_poll_deals:
            did = str(deal["id"])
            dist = bot_data.distribution_cache.get(did, {})
            if not dist:
                continue

            report.append(f"\nüéØ *{deal['name']}* ‚Äî {deal['event_datetime_str']}")

            for role, tag in dist.items():
                emoji = {
                    "lead": "üß≠", "assistant": "üõü", "admin": "üõ°Ô∏è", "intern": "üë∑"
                }.get(role.split("1")[0], "üë§")
                txt = tag or "_–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω_"
                report.append(f"{emoji} {role.capitalize()}: {txt}")

        await callback.message.answer("\n".join(report), parse_mode="Markdown")
        await callback.answer()

        logger.debug("[13.0.2] distribute_leaders_handler: done")

    except Exception as e:
        logger.error("[13.0.2] distribute_leaders_handler: –û—à–∏–±–∫–∞: %s", e, exc_info=True)
        await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.", show_alert=True)

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë            [13.0.3] save_distribution_to_amocrm_handler (fixed)           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏ update_amocrm_tags + –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç—á—ë—Ç –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
# version: 1.1 (30.05.2025)

@router.callback_query(lambda c: c.data == "save_distribution")
async def save_distribution_to_amocrm_handler(callback: types.CallbackQuery) -> None:
    user_id = callback.from_user.id
    logger.debug("[13.0.3] save_distribution_to_amocrm_handler: start for user %d", user_id)

    try:
        # –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
        if not await has_access(user_id, "poll"):
            await callback.answer("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.", show_alert=True)
            return

        # –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–∂–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ
        if not bot_data.distribution_cache:
            await callback.answer("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.", show_alert=True)
            return

        updates: list[str] = []

        for deal in bot_data.current_poll_deals:
            did_str = str(deal["id"])
            dist    = bot_data.distribution_cache.get(did_str, {})
            tags    = [t for t in dist.values() if t]  # —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ —Ç–µ–≥–∏

            if not tags:
                updates.append(f"‚ö†Ô∏è {deal['name']} ‚Äî –Ω–µ—Ç —Ç–µ–≥–æ–≤ –¥–ª—è –∑–∞–ø–∏—Å–∏")
                continue

            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ AmoCRM
            success = await update_amocrm_tags(deal_id=deal["id"], tags=tags)
            updates.append(f"{'‚úÖ' if success else '‚ùå'} {deal['name']}")

        report = "\n".join(updates) if updates else "‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è."
        await callback.message.answer(
            f"üíæ *–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ AmoCRM:*\n{report}",
            parse_mode="Markdown"
        )
        await callback.answer("–ì–æ—Ç–æ–≤–æ.")

        logger.info("[13.0.3] save_distribution_to_amocrm_handler: completed")

    except Exception as e:
        logger.error("[13.0.3] save_distribution_to_amocrm_handler: %s", e, exc_info=True)
        await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.", show_alert=True)
# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë        [13.0.4] delete_previous_private_messages  (v3.4 ‚Äì 12-06-2025)    ‚ïë
# ‚ïë  ‚Ä¢ —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è¬ª –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º                       ‚ïë
# ‚ïë  ‚Ä¢ –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π                                        ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
async def delete_previous_private_messages(user_id: int) -> None:
    """
    –û—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Ç–æ–ª—å–∫–æ ¬´–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è¬ª, —É–¥–∞–ª—è—è:
      ‚Ä¢ last_user_messages
      ‚Ä¢ detail_blocks
      ‚Ä¢ orphan-ids
      ‚Ä¢ –ª–∏—á–Ω—ã–π –æ—Ç—á—ë—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è
    """
    # 1Ô∏è‚É£ –æ–±—ä–µ–∫—Ç—ã Message –∏–∑ last_user_messages
    msg_objects: list[types.Message] = bot_data.last_user_messages.pop(user_id, [])

    # 2Ô∏è‚É£ detail_blocks –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    for key in [k for k in list(bot_data.detail_blocks) if k[0] == user_id]:
        msg_objects += bot_data.detail_blocks.pop(key, [])

    # 3Ô∏è‚É£ orphan-ids
    orphan_ids: list[int] = bot_data.messages_to_delete.pop(user_id, [])

    # 4Ô∏è‚É£ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è
    if user_id == bot_data.current_poll_leader and bot_data.personal_report_message_id:
        orphan_ids.append(bot_data.personal_report_message_id)
        bot_data.personal_report_message_id = None

    # 5Ô∏è‚É£ —É–¥–∞–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–µ
    ok = fail = 0
    for m in msg_objects:
        try:
            await m.delete(); ok += 1
        except Exception:
            fail += 1
    for mid in orphan_ids:
        try:
            await bot.delete_message(chat_id=user_id, message_id=mid); ok += 1
        except Exception:
            fail += 1

    logger.debug("[13.0.4] vacuum uid=%d ‚Üí %d ok | %d fail", user_id, ok, fail)

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                        [13.0.5] report_unknown_names                     ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –°–æ–æ–±—â–∞–µ—Ç –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö, –Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ.
# version: 4.9.0 (MasterBot 12.90)

async def report_unknown_names() -> None:
    logger.debug("[13.0.5] report_unknown_names: start")
    try:
        unknown = []
        for data in bot_data.responses.values():
            for deal_id, users in data["deals"].items():
                for u in users:
                    if not get_user_info(u["user_id"]):
                        unknown.append(u["first_name"])
            for u in data["admin_available"] + data["not_available"]:
                if not get_user_info(u["user_id"]):
                    unknown.append(u["first_name"])
        if unknown:
            text = "‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: " + ", ".join(sorted(set(unknown)))
            await bot.send_message(bot_data.current_poll_leader, text, parse_mode="Markdown")
        logger.debug("[13.0.5] report_unknown_names: done")
    except Exception as e:
        logger.error("[13.0.5] report_unknown_names: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö: %s", e, exc_info=True)


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                         [13.2] clear_poll_data                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –û—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–ª–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É.
# version: 12.90

async def clear_poll_data(user_id: int) -> None:
    logger.debug("[13.2] clear_poll_data: start for user %d", user_id)
    try:
        bot_data.responses.clear()
        bot_data.current_poll_deals.clear()
        bot_data.distribution_cache.clear()
        bot_data.personal_report_message_id = None
        bot_data.current_poll_leader = None
        bot_data.coordination_cycle_active = False
        bot_data.distribution_keyboard = None
        bot_data.current_event_period = None
        logger.info("[13.2] clear_poll_data: –î–∞–Ω–Ω—ã–µ –æ–ø—Ä–æ—Å–∞ –æ—á–∏—â–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %d", user_id)
    except Exception as e:
        logger.error("[13.2] clear_poll_data: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %d: %s", user_id, e, exc_info=True)


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                        [13.3] handle_poll_answer  (v2.4 ‚Äì 11-06-2025)     ‚ïë
# ‚ïë  ‚Ä¢ online-–∏–Ω–¥–∏–∫–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞—ë—Ç—Å—è (detail-refresh)              ‚ïë
# ‚ïë  ‚Ä¢ –æ—Ç—á—ë—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è —Ç–µ–ø–µ—Ä—å –¢–û–õ–¨–ö–û –æ–¥–∏–Ω:                                 ‚ïë
# ‚ïë      ‚Äì ‚Äúmessage is not modified‚Äù ‚Üí —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö                          ‚ïë
# ‚ïë      ‚Äì –ø—Ä–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –æ—à–∏–±–∫–µ —Å—Ç–∞—Ä—ã–π –æ—Ç—á—ë—Ç —É–¥–∞–ª—è–µ—Ç—Å—è –∏ —à–ª—ë—Ç—Å—è –Ω–æ–≤—ã–π      ‚ïë
# ‚ïë      ‚Äì last_user_messages –∏ personal_report_message_id –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è        ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
@router.poll_answer()
async def handle_poll_answer(event: types.PollAnswer) -> None:
    uid, poll_id, chosen = event.user.id, event.poll_id, event.option_ids
    logger.debug("[13.3] handle_poll_answer: poll=%s user=%d choices=%s",
                 poll_id, uid, chosen)

    # ‚Äî‚Äî‚Äî –æ–ø—Ä–æ—Å –Ω–µ –Ω–∞—à ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    if poll_id not in bot_data.responses:
        return
    data = bot_data.responses[poll_id]

    # ‚Äî‚Äî‚Äî 1. —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    for lst in data["deals"].values():
        lst[:] = [u for u in lst if u["user_id"] != uid]
    data["not_available"][:]   = [u for u in data["not_available"]   if u["user_id"] != uid]
    data["admin_available"][:] = [u for u in data["admin_available"] if u["user_id"] != uid]

    # ‚Äî‚Äî‚Äî 2. –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –≤—ã–±–æ—Ä—ã ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    ui   = get_user_info(uid) or {}
    base = {
        "user_id": uid,
        "first_name": ui.get("first_name", ""),
        "last_name_initial": ui.get("last_name_initial", ""),
        "is_admin_eligible": False
    }
    num_games   = len(data["deal_indices"])
    impacted: set[int] = set()
    refresh_all = False

    for idx in chosen:
        if idx < num_games:                               # –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∏–≥—Ä–∞
            did = data["deal_indices"][idx]
            data["deals"][did].append(base.copy())
            impacted.add(did)
        elif idx == num_games:                            # üö´
            data["not_available"].append(base.copy())
        elif idx == num_games + 1:                        # üõ°Ô∏è
            adm = base.copy(); adm["is_admin_eligible"] = True
            data["admin_available"].append(adm)
            refresh_all = True

    # –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª ¬´üõ°Ô∏è¬ª ‚Äì —É–±–∏—Ä–∞–µ–º –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–æ–≤ –∏–≥—Ä (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª—Å—è)
    if refresh_all:
        for lst in data["deals"].values():
            lst[:] = [u for u in lst if not u.get("is_admin_eligible")]

    # ‚Äî‚Äî‚Äî 3. –æ–±–Ω–æ–≤–ª—è–µ–º / –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –æ—Ç—á—ë—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    async def _sync_leader_report() -> None:
        new_text = await generate_poll_report()
        leader   = bot_data.current_poll_leader
        msg_id   = bot_data.personal_report_message_id

        if not leader:                                   # –Ω–∞ –≤—Å—è–∫–∏–π
            return

        try:
            await bot.edit_message_text(
                new_text, chat_id=leader, message_id=msg_id,
                parse_mode="Markdown", reply_markup=bot_data.distribution_keyboard
            )
            return                                        # üéâ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏
        except TelegramBadRequest as e:
            if "message is not modified" in str(e):
                logger.debug("[13.3] report unchanged ‚Üí skip")
                return                                    # —Ç–µ–∫—Å—Ç —Ç–æ—Ç –∂–µ ‚Äì –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            # –∏–Ω–∞—á–µ: —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–ø–∞–ª–æ / —Ä–∞–≤–Ω—ã—Ö –ø—Ä–∞–≤ –Ω–µ—Ç ‚Üí –ø—Ä–∏—à–ª—ë–º –Ω–æ–≤–æ–µ
            logger.warning("[13.3] report edit failed: %s ‚Äî recreating", e)

        # —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ—Ç—á—ë—Ç, –µ—Å–ª–∏ –æ–Ω –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if msg_id:
            try:
                await bot.delete_message(chat_id=leader, message_id=msg_id)
            except Exception:
                pass

        sent = await bot.send_message(
            leader, new_text, parse_mode="Markdown",
            reply_markup=bot_data.distribution_keyboard
        )
        bot_data.personal_report_message_id = sent.message_id
        bot_data.last_user_messages[leader] = [sent]      # vacuum —É–≤–∏–¥–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç

    try:
        await _sync_leader_report()
    except Exception as e:
        logger.error("[13.3] leader report sync error: %s", e, exc_info=True)

    # ‚Äî‚Äî‚Äî 4. live-refresh detail-—ç–∫—Ä–∞–Ω–æ–≤ ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    try:
        if refresh_all:
            impacted = {d["id"] for d in bot_data.current_poll_deals}
        tasks = [
            refresh_deal_details(u_id, d_id)
            for (u_id, d_id) in list(bot_data.detail_blocks)
            if d_id in impacted
        ]
        if tasks:
            await asyncio.gather(*tasks, return_exceptions=True)
            logger.debug("[13.3] %d detail views refreshed", len(tasks))
    except Exception as e:
        logger.error("[13.3] detail refresh error: %s", e, exc_info=True)

# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# v2.4 ‚Äì 11-06-2025 ‚Äî –æ–¥–∏–Ω –æ—Ç—á—ë—Ç –±–µ–∑ –¥—É–±–ª–µ–π; online-refresh —Å–æ—Ö—Ä–∞–Ω—ë–Ω.
# v2.3 ‚Äì –ø—Ä–æ—á–∏–µ —Ñ–∏–∫—Å—ã.


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                         [13.4] –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞                     ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –£–ø—Ä–æ—â—ë–Ω–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —Ä–æ–ª—è–º
# version: 1.0 (27.05.2025) ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –æ–¥–Ω—É –∏–≥—Ä—É

@router.callback_query(lambda c: c.data == "manual_edit")
async def manual_edit_menu(callback: types.CallbackQuery) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–≥—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∞."""
    try:
        kb = InlineKeyboardBuilder()
        for deal in bot_data.current_poll_deals:
            name = deal["name"]
            date = deal["event_datetime"].strftime("%d.%m")
            kb.button(text=f"‚úèÔ∏è {name} ‚Äî {date}", callback_data=f"edit_compact_{deal['id']}")
        kb.adjust(1)

        await callback.message.answer("üõ† –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∞:", reply_markup=kb.as_markup())
        await callback.answer()
    except Exception as e:
        logger.error("[13.4] manual_edit_menu: %s", e, exc_info=True)
        await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–≥—Ä.", show_alert=True)


@router.callback_query(lambda c: c.data.startswith("edit_compact_"))
async def edit_compact_roles(callback: types.CallbackQuery) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–∞–≤ —Ä–æ–ª–µ–π –Ω–∞ –æ–¥–Ω—É –∏–≥—Ä—É, –∫–∞–∂–¥–∞—è —Ä–æ–ª—å ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞."""
    try:
        deal_id = int(callback.data.split("_")[-1])
        deal = next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        if not deal:
            await callback.answer("‚ö†Ô∏è –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
            return

        roles = bot_data.distribution_cache.get(str(deal_id), {})
        kb = InlineKeyboardBuilder()

        for role, name in roles.items():
            btn_text = f"{role.capitalize()}: {name or '‚Äî'}"
            kb.button(text=btn_text, callback_data=f"select_user_{deal_id}_{role}")
        kb.adjust(1)

        await callback.message.answer(f"üõ† –°–æ—Å—Ç–∞–≤ –¥–ª—è *{deal['name']}*:", reply_markup=kb.as_markup(), parse_mode="Markdown")
        await callback.answer()

    except Exception as e:
        logger.error("[13.4] edit_compact_roles: %s", e, exc_info=True)
        await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ä–æ–ª–µ–π.", show_alert=True)


@router.callback_query(lambda c: c.data.startswith("select_user_"))
async def select_user_for_role(callback: types.CallbackQuery) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–æ–ª—å –≤ –∏–≥—Ä–µ."""
    try:
        _, deal_id, role = callback.data.split("_", 2)
        deal_id = int(deal_id)
        deal = next((d for d in bot_data.current_poll_deals if d["id"] == deal_id), None)
        if not deal:
            await callback.answer("‚ö†Ô∏è –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
            return

        candidates = []
        for p in bot_data.responses.values():
            candidates += p["deals"].get(deal_id, [])

        # —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ä–æ–ª–∏
        filtered = []
        for u in candidates:
            status = await get_user_status_from_svetofor(u["user_id"], deal["game_name"])
            if role.startswith("lead") and status == "green":
                filtered.append(u)
            elif role.startswith("assistant") and status in ("green", "yellow"):
                filtered.append(u)
            elif role == "admin" and u.get("is_admin_eligible"):
                filtered.append(u)
            elif role == "intern" and status == "red":
                filtered.append(u)

        kb = InlineKeyboardBuilder()
        for u in filtered:
            name = f"{u['first_name']} {u['last_name_initial']}"
            kb.button(text=name, callback_data=f"assign_{deal_id}_{role}_{u['user_id']}")
        kb.button(text="‚õî –£–±—Ä–∞—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ", callback_data=f"assign_{deal_id}_{role}_none")
        kb.adjust(1)

        await callback.message.answer(f"üë§ –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ —Ä–æ–ª—å `{role}` –≤ *{deal['name']}*:", reply_markup=kb.as_markup(), parse_mode="Markdown")
        await callback.answer()

    except Exception as e:
        logger.error("[13.4] select_user_for_role: %s", e, exc_info=True)
        await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.", show_alert=True)


@router.callback_query(lambda c: c.data.startswith("assign_"))
async def assign_user_to_role(callback: types.CallbackQuery) -> None:
    """–ù–∞–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ä–æ–ª—å –∏–ª–∏ —Å–Ω–∏–º–∞–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ."""
    try:
        _, deal_id, role, user_id = callback.data.split("_", 3)
        deal_id = str(deal_id)
        user_id = None if user_id == "none" else int(user_id)

        if deal_id not in bot_data.distribution_cache:
            bot_data.distribution_cache[deal_id] = {}

        if user_id:
            info = get_user_info(user_id)
            name = f"{info['first_name']} {info['last_name_initial']}" if info else "??"
            suffix = {
                "lead": ".1", "assistant": ".–ü–æ–º", "admin": ".–ê–¥", "intern": ".–°—Ç–∞–∂"
            }.get(role.split("1")[0], "")
            tag = f"{name}{suffix}"
        else:
            tag = ""

        bot_data.distribution_cache[deal_id][role] = tag
        await callback.answer("‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.")
        await edit_compact_roles(callback)  # –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –º–µ–Ω—é

    except Exception as e:
        logger.error("[13.4] assign_user_to_role: %s", e, exc_info=True)
        await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏.", show_alert=True)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# version: 1.0 (27.05.2025)
# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# - 1.0: –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å–æ—Å—Ç–∞–≤–∞ –ø–æ —Ä–æ–ª—è–º —á–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ –±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –º–µ–Ω—é


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                   [15.0] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Google Sheets                         ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ Google Sheets.
# version: 1.1

async def create_distribution_table(spreadsheet_id: str, deals: List[Dict], distribution: Dict) -> None:
    """–°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ Google Sheets.

    Args:
        spreadsheet_id: ID —Ç–∞–±–ª–∏—Ü—ã Google Sheets.
        deals: –°–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫.
        distribution: –°–ª–æ–≤–∞—Ä—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
    """
    try:
        creds = Credentials.from_service_account_file(GOOGLE_CREDENTIALS_FILE, scopes=GOOGLE_SHEETS_SCOPES)
        client = gspread.authorize(creds)
        spreadsheet = client.open_by_key(spreadsheet_id)
        sheet = spreadsheet.worksheet(DISTRIBUTION_SPREADSHEET_NAME)

        headers = ["ID —Å–¥–µ–ª–∫–∏", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è", "–ö–≤–µ—Å—Ç", "–í–µ–¥—É—â–∏–π 1", "–í–µ–¥—É—â–∏–π 2", "–ü–æ–º–æ—â–Ω–∏–∫ 1", "–ü–æ–º–æ—â–Ω–∏–∫ 2", "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"]
        data = [headers]

        for deal in deals:
            deal_id = str(deal["id"])
            dist = distribution.get(deal_id, {})
            row = [
                deal["id"],
                deal["name"],
                deal["event_datetime_str"],
                deal["game_name"],
                dist.get("lead1", ""),
                dist.get("lead2", ""),
                dist.get("assistant1", ""),
                dist.get("assistant2", ""),
                dist.get("admin", "")
            ]
            data.append(row)

        sheet.clear()
        sheet.update("A1", data)
        logger.info("[15.0] create_distribution_table: –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞, —Å—Ç—Ä–æ–∫: %d", len(data))
    except Exception as e:
        logger.error("[15.0] create_distribution_table: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: %s", e, exc_info=True)

# version: 1.1
# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# - 1.0: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è Google Sheets.
# - 1.1 (11.05.2025): –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏.


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                     [16.0] show_games (v3.2, single-screen)              ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –ü–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä –≤ last_user_messages –æ—Å—Ç–∞—ë—Ç—Å—è —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç.
# version: 3.2 (08.06.2025)
from contextlib import asynccontextmanager
import asyncio

_user_locks: dict[int, asyncio.Lock] = {}

@asynccontextmanager
async def user_lock(uid: int):
    """–ü–µ—Ä-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–º–æ–∫,
    —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≥–æ–Ω–æ–∫ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–ª–∏–∫–∞—Ö."""
    lock = _user_locks.setdefault(uid, asyncio.Lock())
    await lock.acquire()
    try:
        yield
    finally:
        lock.release()

async def show_games(
    message: types.Message,
    user_id: int,
    status_ids: list[str],
    title: str,
    only_unassigned: bool | None = None,
) -> None:
    async with user_lock(user_id):
        logger.debug("[16.0] === show_games START for %d ===", user_id)

        # 0. —á–∏—Å—Ç–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω
        await delete_previous_private_messages(user_id)

        # 1. —Å–¥–µ–ª–∫–∏
        spread_id = bot_data.config.get("svetofor_spread_id")
        if not spread_id:
            await message.answer("‚ö†Ô∏è –ù–µ —É–∫–∞–∑–∞–Ω ID —Ç–∞–±–ª–∏—Ü—ã ¬´–°–≤–µ—Ç–æ—Ñ–æ—Ä¬ª.")
            logger.error("[16.0] show_games: –Ω–µ—Ç spread_id")
            return

        deals = await get_amocrm_deals(spread_id)
        now   = datetime.now(tz=MSK_TZ)

        if only_unassigned is None:
            only_unassigned = (status_ids == NEW_GAMES_STATUS_IDS)

        filtered = [
            d for d in deals
            if d["status_id"] in status_ids
               and d["event_datetime"] >= now
               and (not only_unassigned or not d["team_leads"])
        ]

        if not filtered:
            await message.answer(f"{title}\nüòî –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –∏–≥—Ä –Ω–µ—Ç.")
            return

        filtered.sort(key=lambda d: d["event_datetime"])
        filtered = filtered[:20]

        # 2. –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        kb = InlineKeyboardBuilder()
        for d in filtered:
            date  = d["event_datetime"].strftime("%d.%m")
            extra = d.get("package") or d.get("extra_services") or ""
            extra = f" ¬∑ {extra}" if extra and extra != "–ù–µ —É–∫–∞–∑–∞–Ω–æ" else ""
            kb.button(
                text=f"üéâ {d['name']} ‚Äî {date}{extra}",
                callback_data=f"game_details_{d['id']}"
            )
        kb.adjust(1)

        # 3. –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –û–î–ù–û —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏
        sent = await message.answer(f"{title}\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:", reply_markup=kb.as_markup())

        bot_data.last_user_messages[user_id] = [sent]
        bot_data.games_by_user[user_id]      = filtered

        logger.info("[16.0] show_games DONE for %d (sent %d games)",
                    user_id, len(filtered))


# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                      [17.0] –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞                              ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
# version: 1.1

async def has_access(user_id: int, access_type: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏–∏.

    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        access_type: –¢–∏–ø –¥–æ—Å—Ç—É–ø–∞ (games, poll, distribution).

    Returns:
        bool: True, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –µ—Å—Ç—å.
    """
    try:
        user_info = get_user_info(user_id)
        if not user_info:
            logger.warning("[17.0] has_access: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %d –Ω–µ –Ω–∞–π–¥–µ–Ω", user_id)
            return False

        role = user_info.get("role", "")
        has_access = role in ACCESS.get(access_type, [])
        logger.debug("[17.0] has_access: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %d (%s) –∑–∞–ø—Ä–æ—Å–∏–ª %s, –¥–æ—Å—Ç—É–ø: %s", user_id, role, access_type, has_access)
        return has_access
    except Exception as e:
        logger.error("[17.0] has_access: –û—à–∏–±–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %d, —Ç–∏–ø %s: %s", user_id, access_type, e, exc_info=True)
        return False

async def is_bot_admin(chat_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –±–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —á–∞—Ç–∞.

    Args:
        chat_id: ID —á–∞—Ç–∞.

    Returns:
        bool: True, –µ—Å–ª–∏ –±–æ—Ç –∞–¥–º–∏–Ω.
    """
    try:
        chat_member = await bot.get_chat_member(chat_id, bot.id)
        is_admin = chat_member.status in ["administrator", "creator"]
        logger.debug("[17.0] is_bot_admin: –ë–æ—Ç –≤ —á–∞—Ç–µ %d, —Å—Ç–∞—Ç—É—Å: %s, –∞–¥–º–∏–Ω: %s", chat_id, chat_member.status, is_admin)
        return is_admin
    except TelegramAPIError as e:
        logger.error("[17.0] is_bot_admin: –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ —á–∞—Ç–µ %d: %s", chat_id, e, exc_info=True)
        return False

# version: 1.1
# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# - 1.0: –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞.
# - 1.1 (11.05.2025): –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏.
# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                                                                           ‚ïë
# ‚ïë                      [18.0] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞                            ‚ïë
# ‚ïë                                                                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# –û–ø–∏—Å–∞–Ω–∏–µ: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ —Ç–æ–∫–µ–Ω–æ–≤, admin_chat_id, –≥–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞–ª–∏—á–∏—è
#           LEADER_ID –≤ –ë–î, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º-–ø–æ–ª–µ–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ –∏ –∑–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞.
# version: 1.4  (17.05.2025)  ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ AMOCRM_FIELDS

async def on_startup() -> None:
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞."""
    try:
        # –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        bot_data.config = await load_json(CONFIG_FILE)
        logger.info("[18.0] on_startup: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ %s", CONFIG_FILE)

        # –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
        bot_data.tokens = await load_json(TOKENS_FILE)
        logger.info("[18.0] on_startup: –¢–æ–∫–µ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ %s", TOKENS_FILE)

        # –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–∞—Å—Ç–æ–º-–ø–æ–ª–µ–π –∏–∑ AMOCRM_FIELDS
        logger.info("[18.0] –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–∞—Å—Ç–æ–º-–ø–æ–ª—è AmoCRM:")
        for name, fid in AMOCRM_FIELDS.items():
            logger.info("    %s ‚Üí %s", name, fid)

        # –ø–æ–ª—É—á–µ–Ω–∏–µ admin_chat_id
        if os.path.exists(CHAT_ID_FILE):
            with open(CHAT_ID_FILE, "r", encoding="utf-8") as f:
                bot_data.admin_chat_id = json.load(f).get("admin_chat_id")
            logger.info("[18.0] on_startup: admin_chat_id=%s", bot_data.admin_chat_id)
        else:
            logger.warning("[18.0] on_startup: —Ñ–∞–π–ª %s –Ω–µ –Ω–∞–π–¥–µ–Ω", CHAT_ID_FILE)

        # ‚îÄ‚îÄ –≥–∞—Ä–∞–Ω—Ç–∏—è LEADER_ID –≤ checklists.db ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        import sqlite3
        db_path = os.path.join(BASE_DIR, "checklists.db")
        conn = sqlite3.connect(db_path)
        cur = conn.cursor()
        cur.execute(
            "CREATE TABLE IF NOT EXISTS users ("
            "user_id INTEGER PRIMARY KEY, first_name TEXT, last_name TEXT, role TEXT, scenario_access TEXT)"
        )
        cur.execute(
            "INSERT OR IGNORE INTO users(user_id, first_name, last_name, role) "
            "VALUES (?, '', '', '—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å')",
            (LEADER_ID,)
        )
        conn.commit()
        conn.close()
        logger.info("[18.0] on_startup: LEADER_ID %d –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ users", LEADER_ID)
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏-–º–∞–ø–ø–∏–Ω–≥–∞ pipeline –∏ —Å—Ç–∞—Ç—É—Å–æ–≤
        await generate_name_mapping()
        logger.info("[18.0] on_startup: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")

    except Exception as e:
        logger.error("[18.0] on_startup: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: %s", e, exc_info=True)
        raise

async def main() -> None:
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ."""
    try:
        global bot, scheduler
        bot = Bot(token=API_TOKEN, default=DefaultBotProperties(parse_mode="Markdown"))
        dp = Dispatcher()
        scheduler = AsyncIOScheduler(timezone=MSK_TZ)

        dp.include_router(router)
        dp.startup.register(on_startup)
        scheduler.start()

        logger.info("[18.0] main: –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω, –≤–µ—Ä—Å–∏—è %s", VERSION)
        await dp.start_polling(bot)
    except Exception as e:
        logger.critical("[18.0] main: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: %s", e, exc_info=True)
        raise

if __name__ == "__main__":
    asyncio.run(main())

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
# - 1.0 (??.05.2025): –±–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
# - 1.1 (11.05.2025): –ª–æ–≥–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ chat_id
# - 1.2 (12.05.2025): –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å MSK_TZ
# - 1.3 (13.05.2025): –≤—Å—Ç–∞–≤–∫–∞ LEADER_ID –≤ –ë–î users
# - 1.4 (17.05.2025): –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ AMOCRM_FIELDS –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º


# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà                                                                         ‚ñà
# ‚ñà                         –ö–æ–Ω–µ—Ü MasterBot 12.92                            ‚ñà
# ‚ñà                                                                         ‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
